{% extends "invite_codes/base.html" %}
{% load static %}

{% block title %}Invite Code Management - Cosmo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/invite-codes-list.css' %}">
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="invite-codes-header">
            <h1 class="card-title">üé´ Invite Code Management</h1>
            <div class="action-buttons">
                <a href="{% if is_manager_portal %}/manager/create-invite-code/{% else %}/admin/create-invite-code/{% endif %}" class="btn btn-primary">
                    ‚ûï Create New Invite Code
                </a>
            </div>
        </div>
    </div>
    
    <div class="card-body">
        <!-- Filters Section -->
        <div class="card filters-section">
            <div class="card-body">
                <h3 class="filters-title">üîç Filter Invite Codes</h3>
                <form method="get" class="filters-form">
                    <div class="form-group filter-form-group search-field">
                        <label for="search">Search</label>
                        <input type="text" name="search" id="search" class="form-control"
                               value="{{ current_filters.search }}" placeholder="Code, creator, notes...">
                    </div>

                    <div class="form-group filter-form-group">
                        <label for="role">Role</label>
                        <select name="role" id="role" class="form-control">
                            <option value="">All Roles</option>
                            {% for value, label in role_choices %}
                            <option value="{{ value }}" {% if current_filters.role == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group filter-form-group">
                        <label for="status">Status</label>
                        <select name="status" id="status" class="form-control">
                            <option value="">All Status</option>
                            <option value="active" {% if current_filters.status == 'active' %}selected{% endif %}>Active</option>
                            <option value="inactive" {% if current_filters.status == 'inactive' %}selected{% endif %}>Inactive</option>
                            <option value="expired" {% if current_filters.status == 'expired' %}selected{% endif %}>Expired</option>
                        </select>
                    </div>

                    <div class="form-group filter-form-group">
                        <label for="task_group">Task Group</label>
                        <select name="task_group" id="task_group" class="form-control">
                            <option value="">All Groups</option>
                            {% for value, label in task_group_choices %}
                            <option value="{{ value }}" {% if current_filters.task_group == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-actions">
                        <button type="submit" class="btn btn-primary">üîç Filter</button>
                        <a href="{% if is_manager_portal %}/manager/invite-codes/{% else %}/admin/invite-codes/{% endif %}" class="btn btn-secondary">üîÑ Clear</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Invite Codes Table -->
        <div class="card">
            <div class="card-body">
                <div class="codes-table-header">
                    <h3 class="codes-table-title">üìã Invite Codes ({{ invite_codes|length }} total)</h3>
                    {% if invite_codes %}
                    <div class="action-buttons">
                        <button data-action="export-csv" class="btn btn-secondary btn-sm">üìä Export CSV</button>
                    </div>
                    {% endif %}
                </div>

                {% if invite_codes %}
                <div class="table-overflow">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Role</th>
                                <th>Task Group</th>
                                <th>Status</th>
                                <th>Uses</th>
                                <th>Expires</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invite_code in invite_codes %}
                            <tr>
                                <td>
                                    <code class="invite-code">{{ invite_code.code }}</code>
                                </td>
                                <td>
                                    <span class="badge badge-info">{{ invite_code.get_role_display }}</span>
                                </td>
                                <td>
                                    <span class="badge badge-secondary">{{ invite_code.get_task_group_display }}</span>
                                </td>
                                <td>
                                    {% if invite_code.is_active %}
                                        <span class="badge badge-success">Active</span>
                                    {% else %}
                                        <span class="badge badge-danger">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="uses-count">{{ invite_code.used_count }}/{{ invite_code.max_uses|default:"‚àû" }}</span>
                                </td>
                                <td>
                                    {% if invite_code.expires_at %}
                                        {{ invite_code.expires_at|date:"M d, Y" }}
                                        {% if invite_code.is_expired %}
                                            <span class="badge badge-warning">Expired</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="expiry-text">Never</span>
                                    {% endif %}
                                </td>
                                <td>{{ invite_code.created_at|date:"M d, Y" }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{% if is_manager_portal %}/manager/invite-codes/{{ invite_code.id }}/{% else %}/admin/invite-codes/{{ invite_code.id }}/{% endif %}" 
                                           class="btn btn-info btn-sm" title="View Details">üëÅÔ∏è</a>
                                        
                                        {% if invite_code.used_count == 0 %}
                                        <a href="{% if is_manager_portal %}/manager/invite-codes/{{ invite_code.id }}/edit/{% else %}/admin/invite-codes/{{ invite_code.id }}/edit/{% endif %}" 
                                           class="btn btn-warning btn-sm" title="Edit">‚úèÔ∏è</a>
                                        {% endif %}
                                        
                                        {% if invite_code.is_active %}
                                        <form method="post" action="{% if is_manager_portal %}/manager/invite-codes/{{ invite_code.id }}/revoke/{% else %}/admin/invite-codes/{{ invite_code.id }}/revoke/{% endif %}"
                                              class="revoke-form" data-action="revoke">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger btn-sm" title="Revoke">üö´</button>
                                        </form>
                                        {% else %}
                                        <form method="post" action="{% if is_manager_portal %}/manager/invite-codes/{{ invite_code.id }}/reactivate/{% else %}/admin/invite-codes/{{ invite_code.id }}/reactivate/{% endif %}"
                                              class="reactivate-form" data-action="reactivate">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-success btn-sm" title="Reactivate">‚úÖ</button>
                                        </form>
                                        {% endif %}

                                        {% if invite_code.used_count == 0 %}
                                        <form method="post" action="{% if is_manager_portal %}/manager/invite-codes/{{ invite_code.id }}/delete/{% else %}/admin/invite-codes/{{ invite_code.id }}/delete/{% endif %}"
                                              class="delete-form" data-action="delete">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger btn-sm" title="Delete">üóëÔ∏è</button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üé´</div>
                    <h3 class="empty-state-title">No Invite Codes Found</h3>
                    <p class="empty-state-message">Get started by creating your first invite code.</p>
                    <a href="{% if is_manager_portal %}/manager/create-invite-code/{% else %}/admin/create-invite-code/{% endif %}" class="btn btn-primary">
                        ‚ûï Create Your First Invite Code
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/pages/invite-codes-list.js' %}"></script>
{% endblock %}
