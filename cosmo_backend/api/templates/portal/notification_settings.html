{% extends "portal/base.html" %}

{% load static %}

{% block title %}My Notifications{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/portal-notification-settings.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="portal-notif-shell">
        <!-- Header -->
        <div class="portal-notif-header">
            <h1 class="portal-notif-title">üîî My Notifications</h1>
            <p class="portal-notif-subtitle">Manage your notifications and preferences</p>
        </div>

        <!-- Unread Count -->
        {% if unread_count > 0 %}
        <div class="portal-notif-unread-wrap">
            <div class="portal-notif-unread-badge">
                üì¨ You have {{ unread_count }} unread notification{{ unread_count|pluralize }}
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="portal-notif-actions">
            {% if unread_count > 0 %}
            <button id="markAllReadBtn" type="button" class="button portal-notif-action-btn portal-notif-action-btn--success" data-action="notif-mark-all-read">
                ‚úì Mark All Read
            </button>
            {% endif %}
            <a href="/api/portal/" class="button portal-notif-action-btn portal-notif-action-btn--muted">
                ‚Üê Back to Portal
            </a>
        </div>

        <!-- Notifications List -->
        <div class="card">
            <div class="portal-notif-card-inner">
                <h3 class="portal-notif-section-title">Recent Notifications</h3>
                
                {% if user_notifications %}
                    <div id="notificationsList">
                        {% for notification in user_notifications %}
                        <div class="notification-item {% if not notification.read %}notification-item--unread{% else %}notification-item--read{% endif %}" data-id="{{ notification.id }}">
                            
                            <div class="notification-row">
                                <div class="notification-main">
                                    <!-- Notification Icon and Status -->
                                    <div class="notification-meta">
                                        {% if not notification.read %}
                                            <div class="notification-unread-dot"></div>
                                        {% endif %}
                                        <span class="notification-verb">
                                            {{ notification.verb.name }}
                                        </span>
                                        <span class="notification-time">
                                            {{ notification.timestamp|timesince }} ago
                                        </span>
                                    </div>
                                    
                                    <!-- Notification Content -->
                                    <div class="notification-desc">
                                        {{ notification.description }}
                                    </div>
                                    
                                    <!-- Target Object Link (if applicable) -->
                                    {% if notification.target_content_type and notification.target_object_id %}
                                    <div class="notification-related">
                                        Related to: {{ notification.target_content_type.name }} #{{ notification.target_object_id }}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="notification-actions">
                                    {% if not notification.read %}
                                    <button type="button" class="portal-notif-mini-btn portal-notif-mini-btn--success" data-action="notif-mark-read" data-notification-id="{{ notification.id }}">
                                        Mark Read
                                    </button>
                                    {% endif %}
                                    
                                    <!-- Link to related object if it's a task -->
                                    {% if notification.target_content_type and notification.target_content_type.model == 'task' and notification.target_object_id %}
                                    <a href="/api/staff/tasks/{{ notification.target_object_id }}/" 
                                       class="portal-notif-mini-link">
                                        View Task
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="portal-notif-empty">
                        <div class="portal-notif-empty-icon">üîï</div>
                        <h4 class="portal-notif-empty-title">No notifications yet</h4>
                        <p class="portal-notif-empty-subtitle">When you receive notifications, they'll appear here.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Notification Preferences (Future Enhancement) -->
        <div class="card portal-notif-preferences">
            <div class="portal-notif-card-inner">
                <h3 class="portal-notif-preferences-title">Notification Preferences</h3>
                <div class="portal-notif-preferences-info">
                    <div class="portal-notif-preferences-row">
                        <span class="portal-notif-preferences-icon">üí°</span>
                        <div class="portal-notif-preferences-body">
                            <h4 class="portal-notif-preferences-subtitle">Coming Soon</h4>
                            <p class="portal-notif-preferences-text">
                                Advanced notification preferences including email notifications, mobile push notifications, and notification filtering will be available in a future update.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<div id="messageContainer" class="portal-notif-message-container hidden">
    <div id="messageContent" class="portal-notif-message-content"></div>
</div>

<script type="module" src="{% static 'js/pages/portal-notification-settings.js' %}"></script>
{% endblock %}