{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}System Crash Recovery | Cosmo Administration{% endblock %}

{% block extrastyle %}
<link rel="stylesheet" href="{% static 'css/pages/admin-system-recovery.css' %}">
{% endblock %}

{% block content %}
<div id="content-main">
    <!-- Header -->
    <div class="recovery-header">
        <a href="/api/admin/metrics/" class="back-link">
            ‚Üê Back to Metrics
        </a>
        <h1 class="recovery-title">üö® System Crash Recovery</h1>
        <p class="recovery-header-subtitle">
            Emergency diagnostics and recovery assistance
        </p>
    </div>

    {% if recovery_info.error %}
    <div class="section-card">
        <div class="section-title">‚ùå Recovery Analysis Error</div>
        <div class="error-alert">
            {{ recovery_info.error }}
        </div>
    </div>
    {% else %}

    <!-- System Status Overview -->
    <div class="status-overview">
        <div class="status-card">
            <div class="status-header">
                <div class="status-icon {{ recovery_info.system_status }}">
                    {% if recovery_info.system_status == 'operational' %}‚úÖ
                    {% elif recovery_info.system_status == 'warning' %}‚ö†Ô∏è
                    {% elif recovery_info.system_status == 'critical' %}‚ùå
                    {% else %}‚ùì{% endif %}
                </div>
                <div>
                    <div class="status-title">System Status</div>
                    <div class="status-badge {{ recovery_info.system_status }}">
                        {{ recovery_info.system_status|title }}
                    </div>
                </div>
            </div>
            <p class="status-description">
                {% if recovery_info.system_status == 'operational' %}
                    System is running normally with no critical issues detected.
                {% elif recovery_info.system_status == 'warning' %}
                    Some warnings detected but system is functional.
                {% elif recovery_info.system_status == 'critical' %}
                    Critical issues detected requiring immediate attention.
                {% else %}
                    Unable to determine system status.
                {% endif %}
            </p>
        </div>

        {% if recovery_info.diagnostic_info %}
        <div class="status-card">
            <div class="status-header">
                <div class="status-icon operational">üîß</div>
                <div>
                    <div class="status-title">Process Status</div>
                    <div class="status-badge operational">
                        {{ recovery_info.diagnostic_info.process_status|default:"Unknown"|title }}
                    </div>
                </div>
            </div>
            <div class="process-metrics">
                <div class="metric-row">
                    <span class="metric-label">Memory Usage:</span>
                    <span class="metric-value">{{ recovery_info.diagnostic_info.memory_usage_mb|default:"?" }} MB</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">CPU Usage:</span>
                    <span class="metric-value">{{ recovery_info.diagnostic_info.cpu_usage_percent|default:"?" }}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Threads:</span>
                    <span class="metric-value">{{ recovery_info.diagnostic_info.threads|default:"?" }}</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Diagnostic Information -->
    {% if recovery_info.diagnostic_info %}
    <div class="section-card">
        <div class="section-title">üîç Diagnostic Information</div>
        <div class="diagnostic-grid">
            {% for key, value in recovery_info.diagnostic_info.items %}
            <div class="diagnostic-item">
                <div class="diagnostic-label">{{ key|title }}</div>
                <div class="diagnostic-value">{{ value }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Recent Errors -->
    <div class="section-card">
        <div class="section-title">üìù Recent Error Log Analysis</div>
        {% if recovery_info.recent_errors %}
        <div class="error-log">
            {% for error in recovery_info.recent_errors %}
            <div class="error-line {{ error.level }}">
                <strong>[{{ error.timestamp }}] {{ error.level }}:</strong> {{ error.line }}
            </div>
            {% endfor %}
        </div>
        <div class="error-log-footer">
            üìä Showing last {{ recovery_info.recent_errors|length }} error entries from error.log
        </div>
        {% else %}
        <div class="no-errors">
            ‚úÖ No recent errors found in error logs
            <br><br>
            <span class="no-errors-subtitle">
                This indicates the system is running without critical issues.
            </span>
        </div>
        {% endif %}
    </div>

    <!-- Recovery Suggestions -->
    <div class="section-card">
        <div class="section-title">üí° Recovery Suggestions</div>
        {% if recovery_info.recovery_suggestions %}
        <ul class="suggestions-list">
            {% for suggestion in recovery_info.recovery_suggestions %}
            <li class="suggestion-item {% if 'critical' in suggestion.lower %}critical{% elif 'warning' in suggestion.lower or 'check' in suggestion.lower %}warning{% endif %}">
                <div>{{ suggestion }}</div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div class="no-errors">
            üìã No specific recovery suggestions available
        </div>
        {% endif %}
    </div>

    {% endif %}

    <!-- Action Buttons -->
    <div class="action-buttons">
        <a href="/api/admin/metrics/" class="action-button">
            üìä System Metrics
        </a>
        <a href="/api/admin/logs/" class="action-button">
            üìù View Full Logs
        </a>
        <button data-action="refresh" class="action-button success">
            üîÑ Refresh Analysis
        </button>
        <button data-action="download-diagnostics" class="action-button warning">
            üíæ Download Diagnostics
        </button>
        <a href="/admin/" class="action-button">
            üè† Admin Dashboard
        </a>
    </div>

    <!-- Emergency Actions -->
    <div class="section-card emergency">
        <div class="section-title danger">üö® Emergency Actions</div>
        <div class="emergency-actions-grid">
            <div class="emergency-action-card">
                <div class="emergency-action-icon">üîÑ</div>
                <h3 class="emergency-action-title">Restart Server</h3>
                <p class="emergency-action-description">
                    If system is unresponsive, restart the Django server process
                </p>
                <code class="emergency-action-command">
                    sudo systemctl restart cosmo
                </code>
            </div>

            <div class="emergency-action-card">
                <div class="emergency-action-icon">üóÑÔ∏è</div>
                <h3 class="emergency-action-title">Database Check</h3>
                <p class="emergency-action-description">
                    Verify database connection and integrity
                </p>
                <code class="emergency-action-command">
                    python manage.py check --database default
                </code>
            </div>

            <div class="emergency-action-card">
                <div class="emergency-action-icon">üßπ</div>
                <h3 class="emergency-action-title">Clear Cache</h3>
                <p class="emergency-action-description">
                    Clear application cache and temporary files
                </p>
                <code class="emergency-action-command">
                    python manage.py clearcache
                </code>
            </div>
        </div>

        <div class="emergency-warning">
            <strong>‚ö†Ô∏è Warning:</strong>
            <span>
                These are emergency recovery actions. Use only if normal operation is impossible.
                Always backup data before performing system-level operations.
            </span>
        </div>
    </div>
</div>

<!-- Recovery data for JavaScript -->
<script type="application/json" id="recovery-data">
{
    "system_status": "{{ recovery_info.system_status|default:'unknown' }}",
    "recent_errors_count": {{ recovery_info.recent_errors|length|default:0 }},
    "diagnostic_info": {{ recovery_info.diagnostic_info|default:"{}"| safe }},
    "recovery_suggestions_count": {{ recovery_info.recovery_suggestions|length|default:0 }}
}
</script>

<script type="module" src="{% static 'js/pages/admin-system-recovery.js' %}"></script>

<script>
// Make recovery info available globally for the module
window.recoveryInfo = JSON.parse(document.getElementById('recovery-data').textContent);
</script>
{% endblock %}
