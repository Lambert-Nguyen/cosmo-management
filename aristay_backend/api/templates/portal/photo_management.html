{% extends "portal/base.html" %}
{% load static %}
{% load timezone_tags %}

{% block title %}Photo Management ¬∑ AriStay Portal{% endblock %}

{% block content %}
<div class="photo-management-container">
    <!-- Header Section -->
    <div class="card">
        <div class="section-title">
            <span class="title-icon">üñºÔ∏è</span>
            Photo Management
        </div>
        <p style="margin: 1rem 0; color: #64748b;">
            Review and approve photos across all tasks. Manage photo status and ensure quality standards.
        </p>
        <div class="header-actions">
            <a href="/api/staff/photos/upload/" class="button" style="background-color: #059669; border-color: #059669;">
                <span class="btn-icon">üì§</span>
                Upload Photos
            </a>
            <a href="/api/portal/" class="button secondary">
                <span class="btn-icon">üè†</span>
                Portal Home
            </a>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-number" id="totalPhotos">-</div>
            <div class="stat-label">Total Photos</div>
        </div>
        <div class="stat-card pending">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-number" id="pendingPhotos">-</div>
            <div class="stat-label">Pending Review</div>
        </div>
        <div class="stat-card approved">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-number" id="approvedPhotos">-</div>
            <div class="stat-label">Approved</div>
        </div>
        <div class="stat-card rejected">
            <div class="stat-icon">‚ùå</div>
            <div class="stat-number" id="rejectedPhotos">-</div>
            <div class="stat-label">Rejected</div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="card">
        <div class="section-title">
            <span class="title-icon">üîç</span>
            Filters & Search
        </div>
        <div class="filters-content">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="taskFilter" class="filter-label">Task</label>
                    <select id="taskFilter" class="filter-select">
                        <option value="">All tasks</option>
                        {% for t in tasks %}
                            <option value="{{ t.id }}" {% if selected_task and selected_task.id == t.id %}selected{% endif %}>
                                #{{ t.id }} ¬∑ {{ t.property_ref.name }} ¬∑ {{ t.title|default:t.get_task_type_display }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="statusFilter" class="filter-label">Status</label>
                    <select id="statusFilter" class="filter-select">
                        <option value="">All Status</option>
                        <option value="pending">‚è≥ Pending</option>
                        <option value="approved">‚úÖ Approved</option>
                        <option value="rejected">‚ùå Rejected</option>
                        <option value="archived">üìÅ Archived</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="typeFilter" class="filter-label">Type</label>
                    <select id="typeFilter" class="filter-select">
                        <option value="">All Types</option>
                        <option value="before">üì∑ Before</option>
                        <option value="after">üì∏ After</option>
                        <option value="checklist">üìã Checklist</option>
                    </select>
                </div>

                <div class="filter-actions">
                    <button id="refreshBtn" class="button">
                        <span class="btn-icon">üîÑ</span>
                        Refresh
                    </button>
                    <button id="clearFiltersBtn" class="button secondary">
                        <span class="btn-icon">üóëÔ∏è</span>
                        Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photos Grid -->
    <div class="card">
        <div class="section-title">
            <span class="title-icon">üì∏</span>
            Photos
            <span class="photo-count" id="photoCount">(0)</span>
        </div>
        <div class="photos-grid" id="photosGrid">
            <div class="loading-state" id="loadingState">
                <div class="loading-spinner"></div>
                <p>Loading photos...</p>
            </div>
        </div>
    </div>
</div>

<!-- Photo Card Template -->
<template id="photoCardTpl">
    <div class="photo-card" data-photo-id="">
        <div class="photo-thumbnail">
            <img data-el="img" src="" alt="" class="photo-image">
            <div class="photo-overlay">
                <button class="photo-action-btn view-btn" title="View Full Size">
                    <span class="btn-icon">üëÅÔ∏è</span>
                </button>
                {% if can_approve_photos %}
                <div class="approval-actions" data-el="actions">
                    <button data-action="approve" class="photo-action-btn approve-btn" title="Approve">
                        <span class="btn-icon">‚úÖ</span>
                    </button>
                    <button data-action="reject" class="photo-action-btn reject-btn" title="Reject">
                        <span class="btn-icon">‚ùå</span>
                    </button>
                    <button data-action="archive" class="photo-action-btn archive-btn" title="Archive">
                        <span class="btn-icon">üìÅ</span>
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="photo-info">
            <div class="photo-meta">
                <span data-el="type" class="photo-type-badge"></span>
                <span data-el="status" class="photo-status-badge"></span>
            </div>
            <div class="photo-details" data-el="meta"></div>
            <div class="photo-actions" data-el="actions">
                {% if can_approve_photos %}
                <button data-action="approve" class="button" style="background-color: #10b981; border-color: #10b981; color: white; font-size: 0.75rem; padding: 0.5rem 0.75rem;">‚úÖ Approve</button>
                <button data-action="reject" class="button" style="background-color: #ef4444; border-color: #ef4444; color: white; font-size: 0.75rem; padding: 0.5rem 0.75rem;">‚ùå Reject</button>
                <button data-action="archive" class="button" style="background-color: #6b7280; border-color: #6b7280; color: white; font-size: 0.75rem; padding: 0.5rem 0.75rem;">üìÅ Archive</button>
                {% endif %}
            </div>
        </div>
    </div>
</template>

<!-- Photo Modal -->
<div id="photoModal" class="photo-modal" style="display: none;">
    <div class="modal-backdrop" onclick="closePhotoModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalPhotoTitle">Photo Viewer</h3>
            <button class="modal-close" onclick="closePhotoModal()">&times;</button>
        </div>
        <div class="modal-body">
            <img id="modalPhoto" src="" alt="Photo" class="modal-photo">
        </div>
        <div class="modal-footer">
            <div class="modal-actions">
                <button class="button secondary" onclick="closePhotoModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Portal-specific photo management styles */
.photo-management-container {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.header-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-top: 1rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.stat-card.pending {
    border-left: 4px solid #f59e0b;
}

.stat-card.approved {
    border-left: 4px solid #10b981;
}

.stat-card.rejected {
    border-left: 4px solid #ef4444;
}

.stat-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.25rem;
}

.stat-label {
    color: #6b7280;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.875rem;
}

.filters-content {
    margin-top: 1rem;
}

.filter-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto;
    gap: 1rem;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.filter-label {
    font-weight: 600;
    color: #374151;
    font-size: 0.875rem;
}

.filter-select {
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: white;
    font-size: 0.875rem;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.filter-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.filter-actions {
    display: flex;
    gap: 0.5rem;
}

.photos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}

.photo-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.photo-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.photo-thumbnail {
    position: relative;
    height: 200px;
    background: #f3f4f6;
    overflow: hidden;
}

.photo-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.photo-card:hover .photo-image {
    transform: scale(1.05);
}

.photo-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.photo-card:hover .photo-overlay {
    opacity: 1;
}

.photo-action-btn {
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s ease;
}

.photo-action-btn:hover {
    background: white;
}

.photo-info {
    padding: 1rem;
}

.photo-meta {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
}

.photo-type-badge, .photo-status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.photo-type-badge {
    background: #eef2ff;
    color: #3730a3;
}

.photo-status-badge.pending {
    background: #fef3c7;
    color: #92400e;
}

.photo-status-badge.approved {
    background: #d1fae5;
    color: #065f46;
}

.photo-status-badge.rejected {
    background: #fee2e2;
    color: #991b1b;
}

.photo-status-badge.archived {
    background: #f3f4f6;
    color: #374151;
}

.photo-details {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 0.75rem;
}

.photo-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.loading-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem;
    color: #6b7280;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e5e7eb;
    border-top: 4px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.photo-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
}

.modal-content {
    position: relative;
    background: white;
    border-radius: 8px;
    max-width: 90vw;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}

.modal-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
}

.modal-body {
    padding: 1rem;
}

.modal-photo {
    max-width: 100%;
    max-height: 70vh;
    object-fit: contain;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #e5e7eb;
}

/* Responsive Design */
@media (max-width: 768px) {
    .filter-row {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .photos-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
    }
    
    .header-actions {
        flex-direction: column;
    }
}
</style>

<script>
const canApprove = {{ can_approve_photos|yesno:"true,false" }};
let currentPhotos = [];

function statusBadgeStyles(status){
  switch(status){
    case 'approved': return 'approved';
    case 'pending': return 'pending';
    case 'rejected': return 'rejected';
    case 'archived': return 'archived';
    default: return 'archived';
  }
}

function getValidTransitions(currentStatus) {
  const validTransitions = {
    'pending': ['approved', 'rejected'],
    'approved': ['archived', 'rejected'],
    'rejected': ['pending', 'archived', 'approved'],
    'archived': ['pending', 'approved', 'rejected']
  };
  
  return validTransitions[currentStatus] || [];
}

async function fetchPhotos(){
  const taskId = document.getElementById('taskFilter').value;
  const url = taskId ? `/api/tasks/${taskId}/images/` : null;
  if(!url){
    showEmptyState('Select a task to view photos.');
    return [];
  }
  
  showLoading();
  
  try {
    const res = await fetch(url, { credentials: 'same-origin' });
    if(!res.ok){ 
      console.error('Failed to fetch photos:', res.status, res.statusText);
      showErrorState('Failed to load photos. Please try again.');
      return []; 
    }
    const data = await res.json();
    const photos = data.results || data;
    currentPhotos = photos;
    updateStats(photos);
    return photos;
  } catch (error) {
    console.error('Error fetching photos:', error);
    showErrorState('Error loading photos. Please check your connection.');
    return [];
  }
}

function updateStats(photos) {
  const total = photos.length;
  const pending = photos.filter(p => p.photo_status === 'pending').length;
  const approved = photos.filter(p => p.photo_status === 'approved').length;
  const rejected = photos.filter(p => p.photo_status === 'rejected').length;
  
  document.getElementById('totalPhotos').textContent = total;
  document.getElementById('pendingPhotos').textContent = pending;
  document.getElementById('approvedPhotos').textContent = approved;
  document.getElementById('rejectedPhotos').textContent = rejected;
}

function showLoading() {
  const grid = document.getElementById('photosGrid');
  grid.innerHTML = `
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading photos...</p>
    </div>
  `;
}

function showEmptyState(message) {
  const grid = document.getElementById('photosGrid');
  grid.innerHTML = `
    <div class="loading-state">
      <div style="font-size: 3rem; margin-bottom: 1rem;">üì∑</div>
      <p>${message}</p>
    </div>
  `;
  updateStats([]);
}

function showErrorState(message) {
  const grid = document.getElementById('photosGrid');
  grid.innerHTML = `
    <div class="loading-state">
      <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
      <p>${message}</p>
    </div>
  `;
  updateStats([]);
}

function renderGrid(items){
  const grid = document.getElementById('photosGrid');
  const statusFilter = document.getElementById('statusFilter').value;
  const typeFilter = document.getElementById('typeFilter').value;

  if (!items || items.length === 0) {
    showEmptyState('No photos found for the selected task.');
    return;
  }

  const filtered = items.filter(p =>
    (!statusFilter || p.photo_status === statusFilter) &&
    (!typeFilter || p.photo_type === typeFilter)
  );

  if (filtered.length === 0) {
    showEmptyState('No photos match the current filters.');
    return;
  }

  const tpl = document.getElementById('photoCardTpl');
  grid.innerHTML = '';
  
  document.getElementById('photoCount').textContent = `(${filtered.length})`;

  filtered.forEach(p => {
    const node = tpl.content.cloneNode(true);
    const card = node.querySelector('.photo-card');
    const img = node.querySelector('[data-el="img"]');
    const type = node.querySelector('[data-el="type"]');
    const status = node.querySelector('[data-el="status"]');
    const meta = node.querySelector('[data-el="meta"]');
    const actions = node.querySelectorAll('[data-el="actions"]');

    card.setAttribute('data-photo-id', p.id);

    if (p.image) {
      img.src = p.image;
      img.alt = `Photo ${p.id}`;
      img.addEventListener('click', () => openPhotoModal(p.image, p));
    } else {
      img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDIwMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMTgwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik04MCA2MEgxMjBWMTIwSDgwVjYwWiIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNODAgODBIMTIwVjEwMEg4MFY4MFoiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+';
      img.alt = 'Missing image';
      img.style.cursor = 'default';
    }

    // Add click handler for view button in overlay
    const viewBtn = card.querySelector('.view-btn');
    if (viewBtn && p.image) {
      viewBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        openPhotoModal(p.image, p);
      });
    }

    type.textContent = (p.photo_type_display || p.photo_type || 'Unknown').toString();
    status.textContent = (p.photo_status_display || p.photo_status || 'Unknown').toString();
    status.className = `photo-status-badge ${statusBadgeStyles(p.photo_status)}`;
    meta.textContent = `ID #${p.id || 'N/A'} ¬∑ seq ${p.sequence_number || 'N/A'} ¬∑ ${p.created_at || 'Unknown date'}`;

    if (canApprove && actions.length > 0){
      actions.forEach(actionContainer => {
        const approveBtn = actionContainer.querySelector('[data-action="approve"]');
        const rejectBtn = actionContainer.querySelector('[data-action="reject"]');
        const archiveBtn = actionContainer.querySelector('[data-action="archive"]');
        
        const currentStatus = p.photo_status;
        const validTransitions = getValidTransitions(currentStatus);
        
        if (approveBtn) {
          if (validTransitions.includes('approved')) {
            approveBtn.style.display = 'inline-block';
            approveBtn.addEventListener('click', () => updateStatus(p, 'approved'));
          } else {
            approveBtn.style.display = 'none';
          }
        }
        
        if (rejectBtn) {
          if (validTransitions.includes('rejected')) {
            rejectBtn.style.display = 'inline-block';
            rejectBtn.addEventListener('click', () => updateStatus(p, 'rejected'));
          } else {
            rejectBtn.style.display = 'none';
          }
        }
        
        if (archiveBtn) {
          if (validTransitions.includes('archived')) {
            archiveBtn.style.display = 'inline-block';
            archiveBtn.addEventListener('click', () => updateStatus(p, 'archived'));
          } else {
            archiveBtn.style.display = 'none';
          }
        }
      });
    }

    grid.appendChild(node);
  });
}

function openPhotoModal(imageSrc, photo) {
  const modal = document.getElementById('photoModal');
  const modalPhoto = document.getElementById('modalPhoto');
  const modalTitle = document.getElementById('modalPhotoTitle');
  
  modalPhoto.src = imageSrc;
  modalTitle.textContent = `Photo #${photo.id} - ${photo.photo_type_display || photo.photo_type || 'Unknown'}`;
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closePhotoModal() {
  const modal = document.getElementById('photoModal');
  modal.style.display = 'none';
  document.body.style.overflow = 'auto';
}

async function updateStatus(photo, newStatus){
  const taskId = document.getElementById('taskFilter').value;
  if(!taskId){ 
    alert('Please select a task first.');
    return; 
  }
  
  if (!photo || !photo.id) {
    alert('Invalid photo data.');
    return;
  }

  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                   document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
  
  try {
    const res = await fetch(`/api/tasks/${taskId}/images/${photo.id}/`, {
      method: 'PATCH',
      headers: { 
        'Content-Type': 'application/json',
        ...(csrfToken && { 'X-CSRFToken': csrfToken })
      },
      credentials: 'same-origin',
      body: JSON.stringify({ photo_status: newStatus })
    });
    
    if(res.ok){
      const statusText = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
      console.log(`Photo ${photo.id} status updated to ${statusText}`);
      load();
    } else {
      const text = await res.text();
      console.error('Update failed:', res.status, text);
      alert(`Failed to update photo status: ${res.status} ${res.statusText}`);
    }
  } catch (error) {
    console.error('Error updating photo status:', error);
    alert('Network error. Please check your connection and try again.');
  }
}

async function load(){
  const items = await fetchPhotos();
  renderGrid(items);
}

function clearFilters() {
  document.getElementById('taskFilter').value = '';
  document.getElementById('statusFilter').value = '';
  document.getElementById('typeFilter').value = '';
  load();
}

// Event Listeners
document.getElementById('taskFilter').addEventListener('change', load);
document.getElementById('statusFilter').addEventListener('change', load);
document.getElementById('typeFilter').addEventListener('change', load);
document.getElementById('refreshBtn').addEventListener('click', load);
document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);

// Close modal on escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closePhotoModal();
  }
});

// Initial load
load();
</script>

{% endblock %}
