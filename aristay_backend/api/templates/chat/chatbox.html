{% extends "layouts/staff_layout.html" %}
{% load static %}

{% block page_title %}Chat{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/chat-chatbox.css' %}">
{% endblock %}

{% block content %}
<div class="chat-container" 
     data-user-id="{{ user_id }}" 
     data-username="{{ username|escapejs }}" 
     data-ws-token="{{ ws_token|escapejs }}">
    <!-- Room List Sidebar -->
    <div class="room-list" id="roomList">
        <div class="room-list-header">
            <h2>ðŸ’¬ Messages</h2>
            <input type="text" class="room-search" id="roomSearch" placeholder="Search conversations...">
        </div>
        
        <div class="room-list-scroll" id="roomListScroll">
            {% if rooms_with_display_names %}
                {% for room_data in rooms_with_display_names %}
                {% with room=room_data.room %}
                <div class="room-item" data-room-id="{{ room.id }}">
                    <div class="room-item-header">
                        <span class="room-name">{{ room_data.display_name }}</span>
                        <span class="room-time">
                            {% if room_data.last_message %}
                                {{ room_data.last_message.created_at|date:"M d, H:i" }}
                            {% else %}
                                Just now
                            {% endif %}
                        </span>
                    </div>
                    <div class="room-preview">
                        {% if room_data.last_message %}
                            {{ room_data.last_message.content|truncatewords:10 }}
                        {% else %}
                            No messages yet
                        {% endif %}
                    </div>
                    {% if room_data.unread_count > 0 %}
                    <span class="unread-badge">{{ room_data.unread_count }}</span>
                    {% else %}
                    <span class="unread-badge hidden">0</span>
                    {% endif %}
                </div>
                {% endwith %}
                {% endfor %}
            {% elif rooms %}
                {# Fallback if rooms_with_display_names not available #}
                {% for room in rooms %}
                <div class="room-item" data-room-id="{{ room.id }}">
                    <div class="room-item-header">
                        <span class="room-name">{{ room.get_display_name }}</span>
                        <span class="room-time">Just now</span>
                    </div>
                    <div class="room-preview">No messages yet</div>
                    <span class="unread-badge hidden">0</span>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ’­</div>
                    <h3>No conversations yet</h3>
                    <p>Start a new chat to get started</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Chat Area -->
    <div class="chat-area" id="chatArea">
        <div id="connectionStatus" class="connection-status hidden">
            Connecting...
        </div>
        
        <div class="chat-header">
            <div>
                <button class="mobile-menu-toggle">â˜°</button>
                <h3 id="chatTitle">Select a conversation</h3>
                <div class="typing-indicator" id="typingIndicator"></div>
            </div>
        </div>
        
        <div class="messages-container" id="messagesContainer">
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ’¬</div>
                <h3>No conversation selected</h3>
                <p>Choose a room from the sidebar to start chatting</p>
            </div>
        </div>
        
        <div class="input-area hidden" id="inputArea">
            <div class="input-wrapper">
                <textarea 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="Type a message..."
                    rows="1"
                ></textarea>
                <button class="send-button" id="sendButton">
                    âž¤
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/pages/chat-chatbox.js' %}"></script>
{% endblock %}

