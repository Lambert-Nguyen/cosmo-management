{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Resolve Booking Conflicts - {{ block.super }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="{% static 'css/pages/admin-conflict-resolution.css' %}">
{% endblock %}

{% block content %}
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
</div>

<div class="sticky-header">
    <h1>üîç Resolve Booking Conflicts</h1>
    <div class="summary">
        <div class="summary-stats">
            <div class="stat">üìä Session: {{ import_session_id }}</div>
            <div class="stat">‚ö†Ô∏è {{ conflicts|length }} Conflicts</div>
            <div class="stat">üë§ {{ import_log.imported_by.username }}</div>
            <div class="stat">üìÖ {{ import_log.imported_at|date:"M d, Y H:i" }}</div>
        </div>
    </div>
</div>

<div class="progress-container">
    <h4 class="progress-section-title">üìà Resolution Progress</h4>
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill" data-progress="0"></div>
    </div>
    <p id="progressText" class="progress-text">0 of {{ conflicts|length }} resolved</p>
</div>

{% if conflicts %}
    {% for conflict in conflicts %}
    <div class="conflict-container" data-conflict-index="{{ forloop.counter0 }}">
        <div class="conflict-header">
            <div>
                <h4>Conflict #{{ forloop.counter }} - Row {{ conflict.row_number }}</h4>
                <div class="conflict-types">
                    {% for conflict_type in conflict.conflict_types %}
                        <span class="conflict-type-badge">{{ conflict_type|title }}</span>
                    {% endfor %}
                </div>
            </div>
            <div class="confidence-score">
                Confidence: {{ conflict.confidence_score|floatformat:1 }}
            </div>
        </div>
        
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Field</th>
                    <th class="existing-data">Current Booking</th>
                    <th class="excel-data">Excel Data</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>External Code</strong></td>
                    <td class="existing-data">{{ conflict.existing_booking.external_code }}</td>
                    <td class="excel-data">{{ conflict.excel_data.external_code }}</td>
                </tr>
                <tr>
                    <td><strong>Guest Name</strong></td>
                    <td class="existing-data">{{ conflict.existing_booking.guest_name }}</td>
                    <td class="excel-data">{{ conflict.excel_data.guest_name }}</td>
                </tr>
                <tr>
                    <td><strong>Property</strong></td>
                    <td class="existing-data">{{ conflict.existing_booking.property_name }}</td>
                    <td class="excel-data">{{ conflict.excel_data.property_name }}</td>
                </tr>
                <tr>
                    <td><strong>Check-in Date</strong></td>
                    <td class="existing-data">{{ conflict.existing_booking.check_in_date }}</td>
                    <td class="excel-data">{{ conflict.excel_data.start_date }}</td>
                </tr>
                <tr>
                    <td><strong>Check-out Date</strong></td>
                    <td class="existing-data">{{ conflict.existing_booking.check_out_date }}</td>
                    <td class="excel-data">{{ conflict.excel_data.end_date }}</td>
                </tr>
                <tr>
                    <td><strong>Status</strong></td>
                    <td class="existing-data">{{ conflict.existing_booking.external_status }}</td>
                    <td class="excel-data">{{ conflict.excel_data.external_status }}</td>
                </tr>
                <tr>
                    <td><strong>Source</strong></td>
                    <td class="existing-data">{{ conflict.existing_booking.source }}</td>
                    <td class="excel-data">{{ conflict.excel_data.source }}</td>
                </tr>
            </tbody>
        </table>
        
        <div class="resolution-buttons">
            <button class="btn btn-primary" data-action="resolve-update" data-conflict-index="{{ forloop.counter0 }}">
                Update Existing Booking
            </button>
            <button class="btn btn-success" data-action="resolve-create" data-conflict-index="{{ forloop.counter0 }}">
                Create New Booking
            </button>
            <button class="btn btn-secondary" data-action="resolve-skip" data-conflict-index="{{ forloop.counter0 }}">
                Skip This Conflict
            </button>
            <button class="btn btn-warning" data-action="preview" data-conflict-index="{{ forloop.counter0 }}">
                Preview Changes
            </button>
        </div>

        <div class="resolution-status hidden" id="status-{{ forloop.counter0 }}">
            <!-- Resolution status will be shown here -->
        </div>
    </div>
    {% endfor %}
    
    <div class="bulk-actions">
        <h4>Bulk Actions</h4>
        <div class="resolution-buttons">
            <button class="btn btn-primary" data-action="bulk-update">
                Update All Existing Bookings
            </button>
            <button class="btn btn-success" data-action="bulk-create">
                Create All as New Bookings
            </button>
            <button class="btn btn-secondary" data-action="bulk-skip">
                Skip All Conflicts
            </button>
        </div>
    </div>
    
{% else %}
    <div class="resolution-summary">
        <h3>No Conflicts Found</h3>
        <p>All bookings were imported successfully without conflicts.</p>
        <a href="{% url 'admin:api_bookingimportlog_changelist' %}" class="btn btn-primary">
            Back to Import Logs
        </a>
    </div>
{% endif %}

<script>
// Define import session ID for use in external JS
window.importSessionId = '{{ import_session_id }}';
</script>
<script src="{% static 'js/pages/admin-conflict-resolution.js' %}"></script>

{% csrf_token %}
{% endblock %}
