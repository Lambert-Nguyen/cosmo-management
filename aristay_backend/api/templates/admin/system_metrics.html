{% extends "admin/base_site.html" %}
{% load static %}
{% load timezone_tags %}

{% block title %}System Metrics Dashboard | AriStay Administration{% endblock %}

{% block extrastyle %}
<link rel="stylesheet" href="{% static 'css/pages/admin-system-metrics.css' %}">
{% endblock %}

{% block content %}
<div id="content-main">
    {% if error %}
    <div class="error-card">
        <h2>‚ö†Ô∏è Error Loading System Metrics</h2>
        <p>{{ error }}</p>
        <button class="retry-button" data-action="retry">
            üîÑ Retry
        </button>
    </div>
    {% else %}
    
    <!-- Header -->
    <div class="metrics-header">
        <div class="auto-refresh-indicator" id="refresh-status">
            üîÑ Auto-refresh: {{ refresh_mode|title }} ({{ refresh_interval }}s)
        </div>
        
        <!-- Refresh Control Panel -->
        <div class="refresh-control-panel">
            <div class="refresh-control-title">Refresh Rate:</div>
            {% for mode, interval in refresh_options.items %}
                <a href="?refresh={{ mode }}" class="refresh-mode-link {% if refresh_mode == mode %}active{% else %}inactive{% endif %}">
                    {{ mode|title }}{% if interval > 0 %} ({{ interval }}s){% endif %}
                </a>
            {% endfor %}
        </div>
        
        <!-- Quick Links -->
        <div class="quick-links">
            <a href="/api/admin/logs/" class="quick-link">
                üìù View Logs
            </a>
            <a href="/api/admin/recovery/" class="quick-link">
                üö® Crash Recovery
            </a>
        </div>
        <h1 class="metrics-title">üìä System Metrics Dashboard</h1>
        <p class="metrics-subtitle">Real-time monitoring and performance insights</p>
        <p class="header-timestamp">
            Last updated: <span id="last-update">{{ metrics.timestamp|dual_timezone:user }}</span>
        </p>
        <p class="header-timezone">
            {% current_time_dual user %}
        </p>
    </div>

    <!-- Health Status Overview -->
    {% if metrics.health_status %}
    <div class="metrics-grid cols-1">
        <div class="metric-card">
            <div class="metric-card-header">
                <div class="metric-icon {% if metrics.health_status.overall_status == 'healthy' %}success{% elif metrics.health_status.overall_status == 'warning' %}warning{% else %}danger{% endif %}">
                    {% if metrics.health_status.overall_status == 'healthy' %}‚úÖ{% elif metrics.health_status.overall_status == 'warning' %}‚ö†Ô∏è{% else %}‚ùå{% endif %}
                </div>
                <div>
                    <div class="metric-title">System Health Status</div>
                    <div class="health-status {{ metrics.health_status.overall_status }}">
                        {{ metrics.health_status.overall_status|title }}
                    </div>
                </div>
            </div>
            
            {% if metrics.health_status.failed_checks %}
            <div class="health-failed-checks">
                <strong>Failed Checks:</strong> {{ metrics.health_status.failed_checks|join:", " }}
            </div>
            {% endif %}

            <div class="metrics-grid cols-4">
                {% for check_name, check_data in metrics.health_status.checks.items %}
                <div class="health-check-item">
                    <div class="health-check-icon">
                        {% if check_data.healthy %}‚úÖ{% else %}‚ùå{% endif %}
                    </div>
                    <div class="health-check-name">{{ check_name|title }}</div>
                    <div class="health-check-status">{{ check_data.status|default:"Unknown" }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Performance Metrics -->
    {% if metrics.performance %}
    <div class="metrics-grid cols-3">
        <!-- CPU Usage -->
        <div class="metric-card">
            <div class="metric-card-header">
                <div class="metric-icon info">üñ•Ô∏è</div>
                <div class="metric-title">CPU Usage</div>
            </div>
            <div class="metric-value">{{ metrics.performance.cpu.usage_percent|floatformat:1 }}%</div>
            <div class="progress-bar" data-metric="cpu">
                <div class="progress-fill {% if metrics.performance.cpu.usage_percent > 80 %}danger{% elif metrics.performance.cpu.usage_percent > 60 %}warning{% endif %}"
                     style="width: {{ metrics.performance.cpu.usage_percent }}%"></div>
            </div>
            <div class="metric-label">{{ metrics.performance.cpu.count }} cores available</div>
        </div>

        <!-- Memory Usage -->
        <div class="metric-card">
            <div class="metric-card-header">
                <div class="metric-icon warning">üíæ</div>
                <div class="metric-title">Memory Usage</div>
            </div>
            <div class="metric-value">{{ metrics.performance.memory.used_percent|floatformat:1 }}%</div>
            <div class="progress-bar" data-metric="memory">
                <div class="progress-fill {% if metrics.performance.memory.used_percent > 85 %}danger{% elif metrics.performance.memory.used_percent > 70 %}warning{% endif %}"
                     style="width: {{ metrics.performance.memory.used_percent }}%"></div>
            </div>
            <div class="metric-label">{{ metrics.performance.memory.available_gb }} GB available</div>
        </div>

        <!-- Disk Usage -->
        <div class="metric-card">
            <div class="metric-card-header">
                <div class="metric-icon success">üíø</div>
                <div class="metric-title">Disk Usage</div>
            </div>
            <div class="metric-value">{{ metrics.performance.disk.used_percent|floatformat:1 }}%</div>
            <div class="progress-bar" data-metric="disk">
                <div class="progress-fill {% if metrics.performance.disk.used_percent > 90 %}danger{% elif metrics.performance.disk.used_percent > 75 %}warning{% endif %}"
                     style="width: {{ metrics.performance.disk.used_percent }}%"></div>
            </div>
            <div class="metric-label">{{ metrics.performance.disk.free_gb }} GB free</div>
        </div>
    </div>
    {% endif %}

    <!-- Application Metrics -->
    {% if metrics.application %}
    <div class="metrics-grid cols-2">
        <!-- Task Metrics -->
        <div class="metric-card">
            <div class="metric-card-header">
                <div class="metric-icon info">üìã</div>
                <div class="metric-title">Task Metrics</div>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Total Tasks</span>
                <span class="metric-item-value">{{ metrics.application.task_metrics.total }}</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Pending</span>
                <span class="metric-item-value">{{ metrics.application.task_metrics.pending }}</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">In Progress</span>
                <span class="metric-item-value">{{ metrics.application.task_metrics.in_progress }}</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Completed</span>
                <span class="metric-item-value">{{ metrics.application.task_metrics.completed }}</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Overdue</span>
                <span class="metric-item-value danger">{{ metrics.application.task_metrics.overdue }}</span>
            </div>
        </div>

        <!-- User Metrics -->
        <div class="metric-card">
            <div class="metric-card-header">
                <div class="metric-icon success">üë•</div>
                <div class="metric-title">User Metrics</div>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Total Users</span>
                <span class="metric-item-value">{{ metrics.application.user_metrics.total }}</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Active Users</span>
                <span class="metric-item-value">{{ metrics.application.user_metrics.active }}</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Staff Members</span>
                <span class="metric-item-value">{{ metrics.application.user_metrics.staff }}</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Superusers</span>
                <span class="metric-item-value">{{ metrics.application.user_metrics.superusers }}</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Logged in (24h)</span>
                <span class="metric-item-value">{{ metrics.application.user_metrics.logged_in_24h }}</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Database & System Info -->
    <div class="metrics-grid cols-2">
        <!-- Database Metrics -->
        {% if metrics.database %}
        <div class="metric-card">
            <div class="metric-card-header">
                <div class="metric-icon info">üóÑÔ∏è</div>
                <div class="metric-title">Database Metrics</div>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Database</span>
                <span class="metric-item-value">{{ metrics.database.vendor|title }}</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Connection</span>
                <span class="metric-item-value">{{ metrics.database.connection_status|title }}</span>
            </div>
            {% for table, count in metrics.database.table_counts.items %}
            <div class="metric-item">
                <span class="metric-item-label">{{ table|title }}</span>
                <span class="metric-item-value">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- System Information -->
        {% if metrics.system_info %}
        <div class="metric-card">
            <div class="metric-card-header">
                <div class="metric-icon success">‚öôÔ∏è</div>
                <div class="metric-title">System Information</div>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Python Version</span>
                <span class="metric-item-value">{{ metrics.system_info.python_version }}</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Platform</span>
                <span class="metric-item-value">{{ metrics.system_info.platform }}</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Hostname</span>
                <span class="metric-item-value">{{ metrics.system_info.hostname }}</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Debug Mode</span>
                <span class="metric-item-value">{{ metrics.system_info.debug_mode|yesno:"On,Off" }}</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Timezone</span>
                <span class="metric-item-value">{{ metrics.system_info.timezone }}</span>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Logging Information -->
    {% if metrics.logging %}
    <div class="metrics-grid cols-1">
        <div class="metric-card">
            <div class="metric-card-header">
                <div class="metric-icon warning">üìù</div>
                <div class="metric-title">Logging Status</div>
            </div>
            
            {% if metrics.logging.log_files %}
            <div class="metrics-grid cols-4">
                {% for log_file, log_data in metrics.logging.log_files.items %}
                <div class="log-file-item">
                    <div class="log-file-name">{{ log_file }}</div>
                    {% if log_data.error %}
                        <div class="log-file-error">{{ log_data.error }}</div>
                    {% else %}
                        <div class="log-file-size">{{ log_data.size_mb }} MB</div>
                        <div class="log-file-lines">{{ log_data.lines }} lines</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="no-log-files">No log files found</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% endif %}
</div>

<script>
// Configuration data for JS
window.metricsRefreshInterval = {{ refresh_interval|default:30 }};
window.metricsRefreshMode = '{{ refresh_mode|default:"normal" }}';
window.metricsApiUrl = '{% url "admin-metrics-api" %}';
</script>
<script src="{% static 'js/pages/admin-system-metrics.js' %}"></script>
{% endblock %}
