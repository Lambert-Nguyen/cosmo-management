{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Email Digest Management - {{ block.super }}{% endblock %}

{% block extrahead %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="{% static 'css/pages/admin-digest-management.css' %}">
{% endblock %}

{% block content %}
<div class="digest-container">
    <!-- Header -->
    <div class="digest-header">
        <h1>üìß Email Digest Management</h1>
        <p>Configure and manage automated daily task digest emails for users</p>
    </div>

    <!-- Status Indicator -->
    <div class="status-indicator-wrapper">
        {% if global_enabled %}
            <div class="status-indicator status-enabled">
                ‚úÖ Email Digest Enabled
            </div>
        {% else %}
            <div class="status-indicator status-disabled">
                ‚ùå Email Digest Disabled (Check Django Settings)
            </div>
        {% endif %}
    </div>

    <!-- Statistics Cards -->
    <div class="stats-cards">
        <div class="stats-card">
            <div class="stat-number">{{ total_users }}</div>
            <div class="stat-label">Total Users</div>
        </div>
        <div class="stats-card">
            <div class="stat-number">{{ eligible_users }}</div>
            <div class="stat-label">Eligible for Digest</div>
        </div>
        <div class="stats-card">
            <div class="stat-number">{{ opted_out_users }}</div>
            <div class="stat-label">Opted Out</div>
        </div>
    </div>

    <!-- Action Cards -->
    <div class="action-cards">
        <!-- Send Digest Card -->
        <div class="action-card">
            <div class="card-header">
                <div class="card-icon send">üì§</div>
                <h3 class="card-title">Send Digest Now</h3>
            </div>
            <p class="card-description">
                Trigger an immediate email digest send to all eligible users. This will send the digest regardless of the normal schedule.
            </p>
            <form id="sendDigestForm">
                {% csrf_token %}
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="testMode" name="test_mode">
                        <label for="testMode">Test Mode (log only, don't send emails)</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" {% if not global_enabled %}disabled{% endif %}>
                    Send Digest
                </button>
            </form>
        </div>

        <!-- Test Digest Card -->
        <div class="action-card">
            <div class="card-header">
                <div class="card-icon test">üß™</div>
                <h3 class="card-title">Test Digest</h3>
            </div>
            <p class="card-description">
                Preview what the digest would look like without actually sending emails. Useful for testing template changes.
            </p>
            <button type="button" class="btn btn-warning" data-action="test-digest" {% if not global_enabled %}disabled{% endif %}>
                Run Test
            </button>
        </div>

        <!-- Settings Card -->
        <div class="action-card">
            <div class="card-header">
                <div class="card-icon settings">‚öôÔ∏è</div>
                <h3 class="card-title">Global Settings</h3>
            </div>
            <p class="card-description">
                Global email digest settings are configured in Django settings. Contact your system administrator to enable/disable the digest globally.
            </p>
            <a href="/admin/" class="btn btn-secondary">
                Django Admin
            </a>
        </div>
    </div>

    <!-- Results Container -->
    <div id="results-container" class="results-container hidden">
        <h3>Results</h3>
        <div id="results-content"></div>
    </div>
</div>

<!-- Loading Indicator -->
<div id="loading" class="loading">
    <div class="spinner"></div>
    Processing request...
</div>

<script>
// Event delegation for test digest button
document.addEventListener('click', function(e) {
    const testBtn = e.target.closest('[data-action="test-digest"]');
    if (testBtn && !testBtn.disabled) {
        testDigest();
    }
});

// Send Digest Form Handler
document.getElementById('sendDigestForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const testMode = document.getElementById('testMode').checked;
    showLoading();

    fetch('', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: new URLSearchParams({
            'action': 'send_digest',
            'test_mode': testMode ? 'on' : ''
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        showResults(data);
    })
    .catch(error => {
        hideLoading();
        showResults({
            success: false,
            error: 'Network error: ' + error.message
        });
    });
});

// Test Digest Function
function testDigest() {
    showLoading();

    fetch('', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: new URLSearchParams({
            'action': 'send_digest',
            'test_mode': 'on'
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        showResults(data);
    })
    .catch(error => {
        hideLoading();
        showResults({
            success: false,
            error: 'Network error: ' + error.message
        });
    });
}

// Utility Functions
function showLoading() {
    document.getElementById('loading').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function showResults(data) {
    const resultsContainer = document.getElementById('results-container');
    const resultsContent = document.getElementById('results-content');

    let html = '';
    if (data.success) {
        html = `
            <div class="result-message result-message-success">
                ‚úÖ ${data.message}
            </div>
        `;
        if (data.sent_count !== undefined) {
            html += `<p><strong>Users processed:</strong> ${data.sent_count}</p>`;
        }
    } else {
        html = `
            <div class="result-message result-message-error">
                ‚ùå ${data.error || data.message || 'Unknown error occurred'}
            </div>
        `;
    }

    resultsContent.innerHTML = html;
    resultsContainer.classList.remove('hidden');

    // Auto-hide results after 10 seconds
    setTimeout(() => {
        resultsContainer.classList.add('hidden');
    }, 10000);
}
</script>
{% endblock %}