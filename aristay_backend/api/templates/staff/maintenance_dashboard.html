{% extends "layouts/staff_layout.html" %}
{% load static %}

{% block page_title %}Maintenance Dashboard{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ total_assigned }}</div>
        <div class="stat-label">Total Assigned</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ overdue_tasks.count }}</div>
        <div class="stat-label">Overdue</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ today_tasks.count }}</div>
        <div class="stat-label">Due Today</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ low_stock_items.count }}</div>
        <div class="stat-label">Low Stock Items</div>
    </div>
</div>

{% if overdue_tasks %}
<div class="card">
    <div class="card-header">
        ğŸš¨ Overdue Tasks
    </div>
    {% for task in overdue_tasks %}
    <div class="task-item task-item--overdue">
        <div class="task-title">
            <a href="/api/staff/tasks/{{ task.id }}/" class="dashboard-task-link">
                {{ task.title }}
            </a>
        </div>
        <div class="task-meta">
            <span>ğŸ  {{ task.property_ref.name }}</span>
            <span class="due-date-overdue">â° Due: {{ task.due_date|date:"M d, H:i" }}</span>
            <span class="status-badge status-{{ task.status|cut:'-' }}">{{ task.get_status_display }}</span>
            {% if task.assigned_to %}
            <span>ğŸ‘¤ {% if task.assigned_to %}{{ task.assigned_to.username }}{% else %}Not assigned{% endif %}</span>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="grid">
    <div class="card">
        <div class="card-header">
            ğŸ”§ Today's Tasks
        </div>
        {% if today_tasks %}
            {% for task in today_tasks %}
            <div class="task-item">
                <div class="task-title">
                    <a href="/api/staff/tasks/{{ task.id }}/" class="dashboard-task-link">
                        {{ task.title }}
                    </a>
                </div>
                <div class="task-meta">
                    <span>ğŸ  {{ task.property_ref.name }}</span>
                    {% if task.due_date %}
                    <span>â° {{ task.due_date|date:"H:i" }}</span>
                    {% endif %}
                    <span class="status-badge status-{{ task.status|cut:'-' }}">{{ task.get_status_display }}</span>
                    {% if task.assigned_to %}
                    <span>ğŸ‘¤ {% if task.assigned_to %}{{ task.assigned_to.username }}{% else %}Not assigned{% endif %}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-emoji-sm">âœ…</div>
                <p>No maintenance tasks due today!</p>
            </div>
        {% endif %}
    </div>

    <div class="card">
        <div class="card-header">
            ğŸ“¦ Low Stock Alerts
        </div>
        {% if low_stock_items %}
            {% for item in low_stock_items %}
            <div class="stock-row">
                <div class="stock-row-info">
                    <div class="stock-row-title">{{ item.item.name }}</div>
                    <div class="stock-row-subtitle">
                        ğŸ  {{ item.property_ref.name }} Â· ğŸ“¦ {{ item.item.category.name }}
                    </div>
                </div>
                <div class="stock-row-right">
                    <div class="status-badge status-{{ item.stock_status|cut:'_' }}">
                        {{ item.current_stock }} {{ item.item.get_unit_display }}
                    </div>
                    <div class="stock-row-par">
                        Par: {{ item.par_level }}
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <div class="center-actions">
                <a href="/api/staff/inventory/" class="btn btn-primary btn-sm">
                    View All Inventory
                </a>
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-emoji-sm">ğŸ“¦</div>
                <p>All inventory levels are healthy!</p>
            </div>
        {% endif %}
    </div>
</div>

<div class="grid">
    <div class="card">
        <div class="card-header">
            ğŸ“‹ All Maintenance Tasks
        </div>
        {% if assigned_tasks %}
            {% for task in assigned_tasks|slice:":10" %}
            <div class="task-item">
                <div class="task-title">
                    <a href="/api/staff/tasks/{{ task.id }}/" class="dashboard-task-link">
                        {{ task.title }}
                    </a>
                </div>
                <div class="task-meta">
                    <span>ğŸ  {{ task.property_ref.name }}</span>
                    {% if task.due_date %}
                    <span>ğŸ“… {{ task.due_date|date:"M d, H:i" }}</span>
                    {% endif %}
                    <span class="status-badge status-{{ task.status|cut:'-' }}">{{ task.get_status_display }}</span>
                </div>
            </div>
            {% endfor %}
            
            {% if assigned_tasks.count > 10 %}
            <div class="center-actions">
                <a href="/api/staff/tasks/?type=maintenance" class="btn btn-secondary btn-sm">
                    View All {{ assigned_tasks.count }} Tasks
                </a>
            </div>
            {% endif %}
        {% else %}
            <div class="empty-state">
                <div class="empty-emoji-md">ğŸ”§</div>
                <h3>No maintenance tasks assigned</h3>
                <p>Check back later or contact your manager.</p>
            </div>
        {% endif %}
    </div>

    <div class="card">
        <div class="card-header">
            ğŸ“Š Recent Inventory Activity
        </div>
        {% if recent_transactions %}
            {% for transaction in recent_transactions %}
            <div class="transaction-row">
                <div class="transaction-row-info">
                    <div class="transaction-row-title">{{ transaction.property_inventory.item.name }}</div>
                    <div class="transaction-row-subtitle">
                        ğŸ  {{ transaction.property_inventory.property_ref.name }}
                    </div>
                </div>
                <div class="transaction-row-right">
                    <div class="transaction-qty {% if transaction.transaction_type == 'stock_in' %}transaction-qty--in{% elif transaction.transaction_type == 'stock_out' %}transaction-qty--out{% else %}transaction-qty--adjust{% endif %}">
                        {% if transaction.transaction_type == 'stock_in' %}+{% elif transaction.transaction_type == 'stock_out' %}-{% endif %}{{ transaction.quantity }} {{ transaction.property_inventory.item.get_unit_display }}
                    </div>
                    <div class="transaction-date">
                        {{ transaction.created_at|date:"M d, H:i" }}
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <div class="center-actions">
                <a href="/api/staff/inventory/" class="btn btn-secondary btn-sm">
                    View Inventory
                </a>
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-emoji-sm">ğŸ“Š</div>
                <p>No recent inventory activity.</p>
            </div>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">
        ğŸ› ï¸ Maintenance Tools & Actions
    </div>
    <div class="grid grid-2">
        <a href="/api/staff/tasks/" class="btn btn-primary">
            ğŸ“‹ View All Tasks
        </a>
        <a href="/api/staff/inventory/" class="btn btn-secondary">
            ğŸ“¦ Manage Inventory
        </a>
        <a href="/api/staff/tasks/?status=in_progress" class="btn btn-secondary">
            ğŸ”„ In Progress Tasks
        </a>
        <a href="/api/staff/lost-found/" class="btn btn-secondary">
            ğŸ” Lost & Found
        </a>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/maintenance-dashboard.css' %}">
{% endblock %}
