{% extends "layouts/staff_layout.html" %}
{% load timezone_tags static %}

{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="task-form-container">
    <div class="card">
        <div class="card-header">
            <div class="header-content">
                <div>
                    <h2 class="task-form-title">{{ title }}</h2>
                    {% if action == 'edit' and task %}
                    <p class="task-form-subtitle">
                        Created {{ task.created_at|dual_timezone:user }} by {{ task.created_by.get_full_name|default:task.created_by.username }}
                    </p>
                    {% endif %}
                </div>
                <div class="header-actions">
                    <a href="/api/staff/tasks/" class="btn btn-secondary">
                        ‚Üê Back to Tasks
                    </a>
                    {% if action == 'edit' and task %}
                    <a href="/api/staff/tasks/{{ task.id }}/" class="btn btn-outline">
                        üëÅÔ∏è View Task
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card-body">
            <form method="post" class="task-form">
                {% csrf_token %}
                
                <div class="form-grid">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h3 class="section-title">üìù Basic Information</h3>
                        
                        <div class="form-group">
                            <label for="{{ form.title.id_for_label }}" class="form-label required">
                                {{ form.title.label }}
                            </label>
                            {{ form.title }}
                            {% if form.title.errors %}
                                <div class="form-errors">
                                    {% for error in form.title.errors %}
                                        <span class="error">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.description.id_for_label }}" class="form-label">
                                {{ form.description.label }}
                            </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="form-errors">
                                    {% for error in form.description.errors %}
                                        <span class="error">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.task_type.id_for_label }}" class="form-label required">
                                {{ form.task_type.label }}
                            </label>
                            {{ form.task_type }}
                            {% if form.task_type.errors %}
                                <div class="form-errors">
                                    {% for error in form.task_type.errors %}
                                        <span class="error">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Assignment & Status -->
                    <div class="form-section">
                        <h3 class="section-title">üë• Assignment & Status</h3>
                        
                        <div class="form-group">
                            <label for="{{ form.assigned_to.id_for_label }}" class="form-label required">
                                {{ form.assigned_to.label }}
                            </label>
                            {{ form.assigned_to }}
                            {% if form.assigned_to.errors %}
                                <div class="form-errors">
                                    {% for error in form.assigned_to.errors %}
                                        <span class="error">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.status.id_for_label }}" class="form-label required">
                                {{ form.status.label }}
                            </label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="form-errors">
                                    {% for error in form.status.errors %}
                                        <span class="error">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Property & Booking -->
                    <div class="form-section">
                        <h3 class="section-title">üè† Property & Booking</h3>
                        
                        <div class="form-group">
                            <label for="{{ form.property_ref.id_for_label }}" class="form-label">
                                {{ form.property_ref.label }}
                            </label>
                            {{ form.property_ref }}
                            {% if form.property_ref.errors %}
                                <div class="form-errors">
                                    {% for error in form.property_ref.errors %}
                                        <span class="error">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.booking.id_for_label }}" class="form-label">
                                {{ form.booking.label }}
                            </label>
                            {{ form.booking }}
                            {% if form.booking.errors %}
                                <div class="form-errors">
                                    {% for error in form.booking.errors %}
                                        <span class="error">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Due Date -->
                    <div class="form-section">
                        <h3 class="section-title">‚è∞ Due Date</h3>
                        
                        <div class="form-group">
                            <label for="{{ form.due_date.id_for_label }}" class="form-label">
                                {{ form.due_date.label }}
                            </label>
                            {{ form.due_date }}
                            {% if form.due_date.errors %}
                                <div class="form-errors">
                                    {% for error in form.due_date.errors %}
                                        <span class="error">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-help">Leave empty for no due date</small>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        {% if action == 'create' %}
                            ‚ú® Create Task
                        {% else %}
                            üíæ Update Task
                        {% endif %}
                    </button>
                    
                    <a href="/api/staff/tasks/" class="btn btn-secondary">
                        ‚ùå Cancel
                    </a>
                    
                    {% if action == 'edit' and task %}
                    <a href="/api/staff/tasks/{{ task.id }}/duplicate/" class="btn btn-outline" 
                       data-confirm="Create a copy of this task?">
                        üìã Duplicate Task
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Additional Actions for Edit Mode -->
    {% if action == 'edit' and task %}
    <div class="card">
        <div class="card-header">
            <h3 class="danger-zone-title">‚ö†Ô∏è Danger Zone</h3>
        </div>
        <div class="card-body">
            <div class="danger-actions">
                <div class="danger-item">
                    <div class="danger-info">
                        <h4>Delete Task</h4>
                        <p>Permanently delete this task. This action cannot be undone.</p>
                    </div>
                    <form method="post" action="/api/staff/tasks/{{ task.id }}/delete/" 
                          class="danger-delete-form"
                          data-confirm="Are you sure you want to delete this task? This action cannot be undone.">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">
                            üóëÔ∏è Delete Task
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/task-form.css' %}">
{% endblock %}

{% block extra_js %}
<script type="module" src="{% static 'js/pages/task-form.js' %}"></script>
{% endblock %}
