{% extends "staff/base.html" %}

{% block title %}{{ task.title }} Â· AriStay{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
        <div>
            <h1 style="margin: 0; color: #333;">{{ task.title }}</h1>
            <div style="margin-top: 0.5rem; color: #666;">
                ğŸ  {{ task.property.name }}
                {% if task.booking %}
                Â· ğŸ“… {{ task.booking.check_in_date|date:"M d" }} â†’ {{ task.booking.check_out_date|date:"M d" }}
                {% endif %}
            </div>
        </div>
        <div style="text-align: right;">
            <div class="status-badge status-{{ task.status|cut:'-' }}" style="margin-bottom: 0.5rem;">
                {{ task.get_status_display }}
            </div>
            {% if task.due_date %}
            <div style="font-size: 0.875rem; color: #666;">
                Due: {{ task.due_date|date:"M d, Y H:i" }}
            </div>
            {% endif %}
        </div>
    </div>

    {% if task.description %}
    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f7fafc; border-radius: 8px;">
        <strong>Description:</strong><br>
        {{ task.description|linebreaks }}
    </div>
    {% endif %}

    <div style="margin-bottom: 1.5rem;">
        <strong>Assigned to:</strong> {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
        {% if task.created_by %}
        Â· <strong>Created by:</strong> {{ task.created_by.get_full_name|default:task.created_by.username }}
        {% endif %}
    </div>
</div>

{% if checklist %}
<div class="card">
    <div class="card-header">
        ğŸ“‹ {{ checklist.template.name }}
        <div style="margin-left: auto; font-size: 1rem; font-weight: normal;">
            Progress: {{ checklist.completion_percentage }}%
        </div>
    </div>
    
    <div class="progress-bar" style="margin-bottom: 1.5rem;">
        <div class="progress-fill" style="width: {{ checklist.completion_percentage }}%"></div>
    </div>

    {% csrf_token %}
    
    {% for room, responses in responses_by_room.items %}
    <div style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem; color: #667eea; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem;">
            {% if room == 'General' %}
                ğŸ“‹ General Tasks
            {% elif room == 'bathroom' %}
                ğŸš¿ Bathroom
            {% elif room == 'bedroom' %}
                ğŸ›ï¸ Bedroom
            {% elif room == 'kitchen' %}
                ğŸ½ï¸ Kitchen
            {% elif room == 'living_room' %}
                ğŸ›‹ï¸ Living Room
            {% else %}
                ğŸ“ {{ room|title }}
            {% endif %}
        </h3>
        
        <div class="grid">
            {% for response in responses %}
            <div class="checklist-item" data-response-id="{{ response.id }}">
                <div style="display: flex; align-items: start; gap: 1rem; margin-bottom: 1rem;">
                    {% if can_edit %}
                    <input type="checkbox" 
                           class="checklist-checkbox"
                           data-response-id="{{ response.id }}"
                           {% if response.is_completed %}checked{% endif %}
                           style="margin-top: 0.25rem;">
                    {% else %}
                    <span style="margin-top: 0.25rem;">
                        {% if response.is_completed %}âœ…{% else %}â¬œ{% endif %}
                    </span>
                    {% endif %}
                    
                    <div style="flex: 1;">
                        <div style="font-weight: 500; margin-bottom: 0.5rem;">
                            {{ response.item.title }}
                            {% if response.item.is_required %}
                            <span style="color: #e53e3e; font-size: 0.875rem;">*</span>
                            {% endif %}
                        </div>
                        
                        {% if response.item.description %}
                        <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">
                            {{ response.item.description }}
                        </div>
                        {% endif %}
                        
                        <div style="font-size: 0.75rem; color: #999; margin-bottom: 0.5rem;">
                            Type: {{ response.item.get_item_type_display }}
                            {% if response.item.item_type == 'blocking' %}
                            <span style="background: #fed7d7; color: #c53030; padding: 0.125rem 0.5rem; border-radius: 4px; margin-left: 0.5rem;">
                                Blocking
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Text input for certain item types -->
                        {% if response.item.item_type == 'text_input' and can_edit %}
                        <textarea placeholder="Enter details..."
                                  class="auto-save"
                                  data-response-id="{{ response.id }}"
                                  data-field="text_response"
                                  style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 4px; margin-top: 0.5rem; min-height: 60px;">{{ response.text_response }}</textarea>
                        {% elif response.item.item_type == 'text_input' and response.text_response %}
                        <div style="background: #f7fafc; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                            {{ response.text_response|linebreaks }}
                        </div>
                        {% endif %}
                        
                        <!-- Number input for certain item types -->
                        {% if response.item.item_type == 'number_input' and can_edit %}
                        <input type="number"
                               placeholder="Enter number..."
                               class="auto-save"
                               data-response-id="{{ response.id }}"
                               data-field="number_response"
                               value="{{ response.number_response|default:'' }}"
                               style="width: 150px; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 4px; margin-top: 0.5rem;">
                        {% elif response.item.item_type == 'number_input' and response.number_response %}
                        <div style="background: #f7fafc; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                            <strong>{{ response.number_response }}</strong>
                        </div>
                        {% endif %}
                        
                        <!-- Photo requirements -->
                        {% if 'photo' in response.item.item_type %}
                        <div style="margin-top: 0.5rem;">
                            {% if response.photos.all %}
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                                {% for photo in response.photos.all %}
                                <img src="{{ photo.image.url }}" 
                                     alt="Checklist photo"
                                     style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px; cursor: pointer;"
                                     onclick="openPhotoModal('{{ photo.image.url }}')">
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            {% if can_edit %}
                            <button type="button" 
                                    class="btn btn-secondary btn-sm"
                                    onclick="document.getElementById('photo-{{ response.id }}').click()">
                                ğŸ“· 
                                {% if response.photos.all %}Update Photo{% else %}Add Photo{% endif %}
                                {% if response.item.item_type == 'photo_required' %}*{% endif %}
                            </button>
                            <input type="file" 
                                   id="photo-{{ response.id }}"
                                   accept="image/*"
                                   style="display: none;"
                                   onchange="uploadPhoto({{ response.id }}, this)">
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <!-- Notes field -->
                        {% if can_edit %}
                        <textarea placeholder="Add notes (optional)..."
                                  class="auto-save"
                                  data-response-id="{{ response.id }}"
                                  data-field="notes"
                                  style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 4px; margin-top: 0.5rem; min-height: 40px; font-size: 0.875rem;">{{ response.notes }}</textarea>
                        {% elif response.notes %}
                        <div style="background: #fffbeb; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; font-size: 0.875rem;">
                            <strong>Notes:</strong> {{ response.notes|linebreaks }}
                        </div>
                        {% endif %}
                        
                        <!-- Completion info -->
                        {% if response.is_completed and response.completed_at %}
                        <div style="font-size: 0.75rem; color: #38a169; margin-top: 0.5rem;">
                            âœ… Completed {{ response.completed_at|date:"M d, H:i" }}
                            {% if response.completed_by %}by {{ response.completed_by.get_full_name|default:response.completed_by.username }}{% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
    
    {% if can_edit %}
    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0; text-align: center;">
        {% if checklist.completion_percentage == 100 %}
        <div class="alert alert-success" style="margin-bottom: 1rem;">
            ğŸ‰ All checklist items completed! You can now mark this task as complete.
        </div>
        <button type="button" class="btn btn-success" onclick="completeTask()">
            âœ… Mark Task Complete
        </button>
        {% else %}
        <div class="alert alert-info">
            Complete all required checklist items to finish this task. 
            Progress: {{ checklist.completion_percentage }}%
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% else %}
<div class="card">
    <div class="empty-state">
        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“‹</div>
        <h3>No Checklist Available</h3>
        <p>This task doesn't have a checklist template assigned.</p>
        {% if can_edit %}
        <div style="margin-top: 1rem;">
            <button type="button" class="btn btn-success" onclick="completeTask()">
                âœ… Mark Task Complete
            </button>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Photo Modal -->
<div id="photoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; cursor: pointer;" onclick="closePhotoModal()">
    <div style="display: flex; align-items: center; justify-content: center; height: 100%; padding: 2rem;">
        <img id="modalPhoto" style="max-width: 90%; max-height: 90%; object-fit: contain;">
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Handle checkbox changes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('checklist-checkbox')) {
            const responseId = e.target.dataset.responseId;
            const isCompleted = e.target.checked;
            
            updateChecklistItem(responseId, 'is_completed', isCompleted)
                .then(data => {
                    if (data.success) {
                        // Update progress bar
                        const progressBar = document.querySelector('.progress-fill');
                        if (progressBar) {
                            progressBar.style.width = data.progress + '%';
                        }
                        
                        // Update progress text
                        const progressText = document.querySelector('.card-header div');
                        if (progressText) {
                            progressText.textContent = 'Progress: ' + data.progress + '%';
                        }
                        
                        // Reload page if task is now complete
                        if (data.progress === 100) {
                            setTimeout(() => location.reload(), 1000);
                        }
                    }
                });
        }
    });
    
    // Photo modal functions
    function openPhotoModal(src) {
        document.getElementById('modalPhoto').src = src;
        document.getElementById('photoModal').style.display = 'block';
    }
    
    function closePhotoModal() {
        document.getElementById('photoModal').style.display = 'none';
    }
    
    // Photo upload
    function uploadPhoto(responseId, input) {
        if (input.files && input.files[0]) {
            const formData = new FormData();
            formData.append('photo', input.files[0]);
            formData.append('response_id', responseId);
            
            fetch('/api/staff/checklist-photo/upload/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Reload to show new photo
                } else {
                    alert('Error uploading photo: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error uploading photo. Please try again.');
            });
        }
    }
    
    // Complete task
    function completeTask() {
        if (confirm('Are you sure you want to mark this task as complete?')) {
            fetch(`/api/tasks/{{ task.id }}/set_status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({'status': 'completed'})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status) {
                    alert('Task marked as complete!');
                    window.location.href = '/api/staff/';
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error completing task. Please try again.');
            });
        }
    }
</script>
{% endblock %}
