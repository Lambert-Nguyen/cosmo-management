{% extends "staff/base.html" %}

{% block title %}{{ task.title }} ¬∑ AriStay{% endblock %}

{% block content %}
<div class="task-detail-container">
    <!-- Enhanced Task Header -->
    <div class="card task-header-card">
        <div class="task-header-content">
            <div class="task-info-section">
                <div class="task-title-section">
                    <h1 class="task-title">{{ task.title }}</h1>
                    <div class="task-badges">
                        <span class="status-badge status-{{ task.status|cut:'-' }}">
                            {{ task.get_status_display }}
                        </span>
                        <span class="type-badge">{{ task.get_task_type_display }}</span>
                        {% if task.due_date %}
                            {% if task.is_overdue %}
                            <span class="priority-badge overdue">‚ö†Ô∏è OVERDUE</span>
                            {% elif task.is_due_soon %}
                            <span class="priority-badge urgent">‚è∞ DUE SOON</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>

                <div class="task-meta-grid">
                    <div class="meta-item">
                        <span class="meta-icon">üè†</span>
                        <span class="meta-text">{{ task.property_ref.name }}</span>
                    </div>
                    {% if task.booking %}
                    <div class="meta-item">
                        <span class="meta-icon">üìÖ</span>
                        <span class="meta-text">
                            {{ task.booking.check_in_date|date:"M j, Y" }} ‚Üí {{ task.booking.check_out_date|date:"M j, Y" }}
                        </span>
                    </div>
                    {% endif %}
                    {% if task.due_date %}
                    <div class="meta-item">
                        <span class="meta-icon">‚è∞</span>
                        <span class="meta-text">{{ task.due_date|date:"M j, Y g:i A" }}</span>
                    </div>
                    {% endif %}
                    <div class="meta-item">
                        <span class="meta-icon">üë§</span>
                        <span class="meta-text">
                            {% if task.assigned_to %}
                                Assigned to {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                            {% else %}
                                Not assigned
                            {% endif %}
                        </span>
                    </div>
                    {% if task.created_by %}
                    <div class="meta-item">
                        <span class="meta-icon">üìù</span>
                        <span class="meta-text">Created by {{ task.created_by.get_full_name|default:task.created_by.username }}</span>
                    </div>
                    {% endif %}
                </div>

                <div class="task-description" {% if not task.description %}style="display: none;"{% endif %}>
                    <h4>Description</h4>
                    <p>{{ task.description|default:"" }}</p>
                </div>
            </div>

            <div class="task-actions-section">
                <!-- CRUD Actions -->
                <div class="crud-actions">
                    <a href="/api/staff/tasks/{{ task.id }}/edit/" class="btn-action edit-task">
                        ‚úèÔ∏è Edit Task
                    </a>
                    <button class="btn-action duplicate-task" onclick="duplicateTask('{{ task.id }}')">
                        üìã Duplicate
                    </button>
                    <button class="btn-action delete-task btn-danger" onclick="deleteTask('{{ task.id }}', '{{ task.title|escapejs }}')">
                        üóëÔ∏è Delete
                    </button>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="btn-action start-task"
                            {% if task.status != 'pending' %}disabled{% endif %}>
                        ‚ñ∂Ô∏è Start Task
                    </button>
                    <button class="btn-action complete-task"
                            {% if task.status == 'completed' %}disabled{% endif %}>
                        ‚úÖ Complete Task
                    </button>
                    <button class="btn-action add-note">
                        üìù Add Note
                    </button>
                    <button class="btn-action share-task">
                        üì§ Share
                    </button>
                    <button class="btn-action report-lost-found">
                        üîç Report Lost & Found
                    </button>
                </div>
                
                <!-- Photo Management Actions -->
                <div class="photo-actions">
                    <a href="/api/staff/photos/upload/?task={{ task.id }}" class="btn-action photo-upload">
                        üì∏ Upload Photos
                    </a>
                    <a href="/api/staff/photos/comparison/{{ task.id }}/" class="btn-action photo-comparison">
                        üîç View Before/After
                    </a>
                </div>

                <!-- Unified Photo Gallery -->
                {% if task.images.all %}
                <div class="unified-photo-gallery">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h4>üì∏ All Task Photos</h4>
                        <button onclick="testPhotoModal()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            Test Modal
                        </button>
                    </div>
                    <div class="photo-gallery-grid">
                        {% for image in task.images.all %}
                        {% if image.image %}
                        <div class="gallery-photo-item" data-photo-type="{{ image.photo_type }}" data-photo-id="{{ image.id }}">
                            <img src="{{ image.image.url }}" 
                                 alt="{{ image.get_photo_type_display }} photo"
                                 data-photo-url="{{ image.image.url }}"
                                 data-photo-id="{{ image.id }}"
                                 onclick="console.log('Photo clicked:', {{ image.id }}); openPhotoModal('{{ image.image.url }}', {{ image.id }})"
                                 style="cursor: pointer;">
                            <div class="photo-meta">
                                <div class="photo-header">
                                    <span class="photo-type-badge">{{ image.get_photo_type_display }}</span>
                                    <span class="photo-status status-{{ image.photo_status }}">{{ image.get_photo_status_display }}</span>
                                </div>
                                {% if image.checklist_response %}
                                <span class="checklist-badge">Checklist</span>
                                {% endif %}
                                {% if image.description %}
                                <p class="photo-description">{{ image.description|truncatechars:50 }}</p>
                                {% endif %}
                                {% if can_approve_photos %}
                                <div class="photo-approval-controls">
                                    {% if image.photo_status == 'pending' %}
                                    <button class="btn-approve" onclick="approvePhoto({{ image.id }})">
                                        ‚úì Approve
                                    </button>
                                    <button class="btn-reject" onclick="rejectPhoto({{ image.id }})">
                                        ‚úó Reject
                                    </button>
                                    {% elif image.photo_status == 'approved' %}
                                    <span class="status-approved">‚úì Approved</span>
                                    <button class="btn-archive" onclick="archivePhoto({{ image.id }})">
                                        üìÅ Archive
                                    </button>
                                    {% elif image.photo_status == 'rejected' %}
                                    <span class="status-rejected">‚úó Rejected</span>
                                    <button class="btn-approve" onclick="approvePhoto({{ image.id }})">
                                        ‚úì Approve
                                    </button>
                                    {% elif image.photo_status == 'archived' %}
                                    <span class="status-archived">üìÅ Archived</span>
                                    <button class="btn-approve" onclick="approvePhoto({{ image.id }})">
                                        ‚úì Unarchive
                                    </button>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <!-- Handle TaskImage objects without files -->
                        <div class="gallery-photo-item photo-error" data-photo-type="{{ image.photo_type }}" data-photo-id="{{ image.id }}">
                            <div class="photo-placeholder">
                                <span class="placeholder-icon">‚ö†Ô∏è</span>
                                <span class="placeholder-text">No Image File</span>
                            </div>
                            <div class="photo-meta">
                                <div class="photo-header">
                                    <span class="photo-type-badge">{{ image.get_photo_type_display }}</span>
                                    <span class="photo-status status-error">Error</span>
                                </div>
                                <p class="photo-description">This photo record has no associated file</p>
                                {% if can_approve_photos %}
                                <div class="photo-approval-controls">
                                    <button class="btn-danger" onclick="deletePhoto({{ image.id }})">
                                        üóëÔ∏è Delete Record
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Task Timer -->
                <div class="task-timer" id="taskTimer">
                    <div class="timer-display">
                        <span class="timer-icon">‚è±Ô∏è</span>
                        <span class="timer-text" id="timerText">00:00:00</span>
                    </div>
                    <div class="timer-controls">
                        <button class="btn-timer" id="startTimerBtn">
                            ‚ñ∂Ô∏è Start
                        </button>
                        <button class="btn-timer" id="pauseTimerBtn" style="display: none;">
                            ‚è∏Ô∏è Pause
                        </button>
                        <button class="btn-timer" id="stopTimerBtn" style="display: none;">
                            ‚èπÔ∏è Stop
                        </button>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="navigation-actions">
                    <button class="btn-nav prev-task">
                        ‚Üê Previous Task
                    </button>
                    <button class="btn-nav next-task">
                        Next Task ‚Üí
                    </button>
                    <button class="btn-nav back-to-list">
                        üìã Back to List
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Progress Overview -->
    {% if checklist %}
    <div class="card progress-overview">
        <div class="progress-header">
            <h3>üìã Task Progress</h3>
            <div class="progress-stats">
                <span class="progress-percentage">{{ checklist.completion_percentage }}%</span>
                <span class="progress-fraction">{{ checklist.completed_items }}/{{ checklist.total_items }} completed</span>
            </div>
        </div>

        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ checklist.completion_percentage }}%"></div>
            </div>
            <div class="progress-milestones">
                <span class="milestone" style="left: 25%">25%</span>
                <span class="milestone" style="left: 50%">50%</span>
                <span class="milestone" style="left: 75%">75%</span>
                <span class="milestone" style="left: 100%">100%</span>
            </div>
        </div>

        <div class="progress-details">
            <div class="detail-item">
                <span class="detail-label">Total Items:</span>
                <span class="detail-value">{{ checklist.total_items }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Completed:</span>
                <span class="detail-value completed">{{ checklist.completed_items }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Remaining:</span>
                <span class="detail-value remaining">{{ checklist.remaining_items }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Time Spent:</span>
                <span class="detail-value" id="timeSpent">00:00:00</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Checklist Sections -->
    {% if checklist %}
    <div class="checklist-container">
        {% csrf_token %}

        {% for room, room_data in responses_by_room.items %}
        <div class="checklist-section">
            <div class="section-header">
                <h3 class="section-title">
                    {% if room == 'General' %}
                        üìã General Tasks
                    {% elif room == 'bathroom' %}
                        üöø Bathroom
                    {% elif room == 'bedroom' %}
                        üõèÔ∏è Bedroom
                    {% elif room == 'kitchen' %}
                        üçΩÔ∏è Kitchen
                    {% elif room == 'living_room' %}
                        üõãÔ∏è Living Room
                    {% else %}
                        üìç {{ room|title }}
                    {% endif %}
                </h3>
                <div class="section-progress">
                    <span class="section-count">{{ room_data.total_count }} items</span>
                    <span class="section-completed">{{ room_data.completed_count }} completed</span>
                </div>
            </div>

            <div class="checklist-grid">
                {% for response in room_data.responses %}
                <div class="checklist-item {% if response.is_completed %}completed{% endif %}"
                     data-response-id="{{ response.id }}"
                     data-item-type="{{ response.item.item_type }}">

                    <div class="checklist-header">
                        <div class="completion-indicator">
                            {% if can_edit %}
                            <input type="checkbox"
                                   class="checklist-checkbox"
                                   data-response-id="{{ response.id }}"
                                   {% if response.is_completed %}checked{% endif %}>
                            {% else %}
                            <span class="checklist-status">
                                {% if response.is_completed %}‚úÖ{% else %}‚¨ú{% endif %}
                            </span>
                            {% endif %}
                        </div>

                        <div class="item-content">
                            <div class="item-title">
                                {{ response.item.title }}
                                {% if response.item.is_required %}
                                <span class="required-indicator">*</span>
                                {% endif %}
                            </div>

                            {% if response.item.description %}
                            <div class="item-description">
                                {{ response.item.description }}
                            </div>
                            {% endif %}

                            <div class="item-meta">
                                <span class="item-type">{{ response.item.get_item_type_display }}</span>
                                {% if response.item.item_type == 'blocking' %}
                                <span class="blocking-badge">üö´ Blocking</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="item-actions">
                            {% if 'photo' in response.item.item_type %}
                            <button class="btn-photo" onclick="openPhotoManager({{ response.id }})">
                                üì∑
                            </button>
                            {% endif %}
                            <button class="btn-notes">
                                üìù
                            </button>
                        </div>
                    </div>

                    <!-- Dynamic Form Fields -->
                    <div class="item-form" id="form-{{ response.id }}">
                        {% if response.item.item_type == 'text_input' and can_edit %}
                        <div class="form-group">
                            <label class="form-label">Details:</label>
                            <textarea class="auto-save form-control"
                                      data-response-id="{{ response.id }}"
                                      data-field="text_response"
                                      placeholder="Enter details...">{{ response.text_response }}</textarea>
                        </div>
                        {% elif response.item.item_type == 'text_input' and response.text_response %}
                        <div class="form-display">
                            <label class="form-label">Details:</label>
                            <div class="form-value">{{ response.text_response|linebreaks }}</div>
                        </div>
                        {% endif %}

                        {% if response.item.item_type == 'number_input' and can_edit %}
                        <div class="form-group">
                            <label class="form-label">Value:</label>
                            <input type="number"
                                   class="auto-save form-control"
                                   data-response-id="{{ response.id }}"
                                   data-field="number_response"
                                   value="{{ response.number_response|default:'' }}"
                                   placeholder="Enter number...">
                        </div>
                        {% elif response.item.item_type == 'number_input' and response.number_response %}
                        <div class="form-display">
                            <label class="form-label">Value:</label>
                            <div class="form-value">{{ response.number_response }}</div>
                        </div>
                        {% endif %}

                        <!-- Photo Management -->
                        {% if 'photo' in response.item.item_type %}
                        <div class="photo-section" id="photos-{{ response.id }}">
                            <label class="form-label">Photos:</label>
                            <div class="photo-grid">
                                {# Unified: render TaskImage linked to this response (checklist photos) #}
                                {% for photo in response.unified_photos %}
                                <div class="photo-item" data-photo-id="{{ photo.id }}">
                                    <img src="{{ photo.image.url }}"
                                         alt="Checklist photo"
                                         data-photo-url="{{ photo.image.url }}"
                                         data-photo-id="{{ photo.id }}">
                                    {% if can_edit %}
                                    <button class="btn-photo-remove" data-item-id="{{ response.id }}" data-photo-url="{{ photo.image.url }}">
                                        √ó
                                    </button>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>

                            {% if can_edit %}
                            <div class="photo-upload">
                                <input type="file"
                                       id="photo-input-{{ response.id }}"
                                       data-item-id="{{ response.id }}"
                                       accept="image/*"
                                       multiple
                                       style="display: none;">
                                <button type="button" class="btn-upload" data-response-id="{{ response.id }}">
                                    üì∑ Add Photos
                                    {% if response.item.item_type == 'photo_required' and not response.unified_photos %}*{% endif %}
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Notes Section -->
                        <div class="notes-section" id="notes-{{ response.id }}" style="display: none;">
                            {% if can_edit %}
                            <div class="form-group">
                                <label class="form-label">Notes:</label>
                                <textarea class="auto-save form-control notes-input"
                                          data-response-id="{{ response.id }}"
                                          data-field="notes"
                                          placeholder="Add notes...">{{ response.notes }}</textarea>
                            </div>
                            {% elif response.notes %}
                            <div class="form-display">
                                <label class="form-label">Notes:</label>
                                <div class="form-value">{{ response.notes|linebreaks }}</div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Completion Info -->
                        {% if response.is_completed and response.completed_at %}
                        <div class="completion-info">
                            <span class="completion-icon">‚úÖ</span>
                            <span class="completion-text">
                                Completed {{ response.completed_at|date:"M d, H:i" }}
                                {% if response.completed_by %}by {{ response.completed_by.get_full_name|default:response.completed_by.username }}{% endif %}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        <!-- Completion Actions -->
        {% if can_edit %}
        <div class="completion-actions">
            {% if checklist.completion_percentage == 100 %}
            <div class="completion-message success">
                üéâ All checklist items completed! You can now mark this task as complete.
            </div>
            <button type="button" class="btn btn-success btn-lg complete-task-btn">
                ‚úÖ Mark Task Complete
            </button>
            {% else %}
            <div class="completion-message info">
                Complete all required checklist items to finish this task.
                Progress: {{ checklist.completion_percentage }}%
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="card empty-checklist">
        <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <h3 class="empty-title">No Checklist Available</h3>
            <p class="empty-message">This task doesn't have a checklist template assigned.</p>
            {% if can_edit %}
            <div class="empty-actions">
                <button type="button" class="btn btn-success" onclick="completeTask({{ task.id }})">
                    ‚úÖ Mark Task Complete
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Task Notes/Comments -->
    <div class="card task-notes">
        <div class="notes-header">
            <h3>üí¨ Task Notes & Comments</h3>
            <button class="btn-add-note">‚ûï Add Note</button>
        </div>
        <div class="notes-list" id="notesList">
            <!-- Notes will be loaded dynamically -->
        </div>
    </div>
</div>

<!-- Enhanced Photo Modal with Zoom and Approval Controls -->
<div id="photoModal" class="photo-modal" style="display: none;">
    <div class="modal-backdrop" onclick="closePhotoModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <div class="photo-info">
                <h3 id="modalPhotoTitle">Photo Viewer</h3>
                <div class="photo-meta-info">
                    <span id="modalPhotoType" class="photo-type-badge"></span>
                    <span id="modalPhotoStatus" class="photo-status"></span>
                    <span id="modalPhotoDate" class="photo-date"></span>
                </div>
            </div>
            <div class="modal-controls">
                <button id="zoomInBtn" class="btn-zoom" title="Zoom In">üîç+</button>
                <button id="zoomOutBtn" class="btn-zoom" title="Zoom Out">üîç-</button>
                <button id="resetZoomBtn" class="btn-zoom" title="Reset Zoom">‚åÇ</button>
                <button class="modal-close" onclick="closePhotoModal()">&times;</button>
            </div>
        </div>
        <div class="modal-body">
            <div class="photo-container">
                <img id="modalPhoto" src="" alt="Photo" class="modal-photo">
            </div>
            <div class="photo-description-container">
                <p id="modalPhotoDescription" class="photo-description"></p>
            </div>
        </div>
        <div class="modal-footer">
            <div class="photo-approval-section">
                <div id="modalApprovalControls" class="photo-approval-controls">
                    <!-- Approval controls will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closePhotoModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Notes Modal -->
<div id="noteModal" class="note-modal" style="display: none;">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Notes</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form class="item-form">
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control notes-input" rows="6" placeholder="Add your notes here..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary modal-close-btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Notes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Lost & Found Modal -->
<div id="lostFoundModal" class="lost-found-modal" style="display: none;">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>üîç Report Lost & Found Item</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="lostFoundForm" class="item-form">
                <div class="form-group">
                    <label class="form-label">Item Title *</label>
                    <input type="text" class="form-control" name="title" required placeholder="e.g., iPhone 12, Wedding Ring, etc.">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description *</label>
                    <textarea class="form-control" name="description" rows="3" required placeholder="Describe the item in detail..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-control" name="category">
                            <option value="">Select category...</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Clothing">Clothing</option>
                            <option value="Jewelry">Jewelry</option>
                            <option value="Personal Items">Personal Items</option>
                            <option value="Documents">Documents</option>
                            <option value="Toys">Toys</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Estimated Value ($)</label>
                        <input type="number" class="form-control" name="estimated_value" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Found Location *</label>
                    <input type="text" class="form-control" name="found_location" required placeholder="e.g., Master bedroom, Kitchen counter, etc.">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Storage Location</label>
                    <input type="text" class="form-control" name="storage_location" placeholder="Where will this item be stored?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Additional Notes</label>
                    <textarea class="form-control" name="notes" rows="2" placeholder="Any additional information..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary modal-close-btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Report Item</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Enhanced Task Detail JavaScript

// Define global functions FIRST (before DOMContentLoaded)
window.startTask = function(taskId) {
    updateTaskStatus(taskId, 'in-progress');
};

window.completeTask = function(taskId) {
    updateTaskStatus(taskId, 'completed');
};

window.uploadPhotos = function(responseId, inputElement) {
    handlePhotoUpload.call(inputElement, { target: inputElement });
};

window.addNote = function() {
    console.log('üìù Opening notes modal...');
    const modal = document.getElementById('noteModal');
    if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Load current task description into the textarea
        const notesInput = modal.querySelector('.notes-input');
        let currentDescription = '';
        
        // First try to get description from template context (most reliable)
        {% if task.description %}
        currentDescription = '{{ task.description|escapejs }}';
        console.log('üìù Description from template:', currentDescription);
        console.log('üìù Raw task.description:', '{{ task.description }}');
        {% else %}
        console.log('üìù No description in template context');
        {% endif %}
        
        // Fallback: try to get description from the task description section
        if (!currentDescription) {
            const descriptionParagraph = document.querySelector('.task-description p');
            console.log('üìù Description paragraph found:', !!descriptionParagraph);
            
            if (descriptionParagraph) {
                currentDescription = descriptionParagraph.textContent.trim();
                console.log('üìù Description from DOM fallback:', currentDescription);
            }
        }
        
        if (notesInput) {
            notesInput.value = currentDescription;
            console.log('üìù Loaded description:', currentDescription);
        }
        
        // Ensure form is reset and event listeners are fresh
        const form = modal.querySelector('.item-form');
        if (form) {
            // Remove any existing event listeners by cloning the form
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
            
            // Re-add event listener
            newForm.addEventListener('submit', handleNotesSave);
            console.log('üìù Form event listener re-attached');
        }
    }
};

window.reportLostFound = function() {
    console.log('üîç Opening lost & found modal...');
    const modal = document.getElementById('lostFoundModal');
    if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Pre-fill some fields based on task context
        const foundLocationInput = modal.querySelector('input[name="found_location"]');
        if (foundLocationInput && !foundLocationInput.value) {
            foundLocationInput.value = '{{ task.property_ref.name }} - Task: {{ task.title }}';
        }
        
        // Ensure form is reset and event listeners are fresh
        const form = modal.querySelector('#lostFoundForm');
        if (form) {
            // Remove any existing event listeners by cloning the form
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
            
            // Re-add event listener
            newForm.addEventListener('submit', handleLostFoundSubmit);
            console.log('üîç Lost & found form event listener attached');
        }
    } else {
        console.error('üîç Lost & found modal not found!');
    }
};

window.shareTask = function() {
    // Implement share functionality
    if (navigator.share) {
        navigator.share({
            title: '{{ task.title }}',
            text: 'Check out this task: {{ task.title }}',
            url: window.location.href
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(window.location.href).then(() => {
            showNotification('Task URL copied to clipboard', 'success');
        });
    }
};

// CRUD Actions
window.duplicateTask = function(taskId) {
    if (confirm('Create a copy of this task?')) {
        window.location.href = `/api/staff/tasks/${taskId}/duplicate/`;
    }
};

window.deleteTask = function(taskId, taskTitle) {
    if (confirm(`Are you sure you want to delete "${taskTitle}"? This action cannot be undone.`)) {
        // Create a form to submit the delete request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/api/staff/tasks/${taskId}/delete/`;
        
        // Add CSRF token
        const csrfToken = getCsrfToken();
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
};

// NOW initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all components
    initializeTaskTimer();
    initializeChecklistManagement();
    initializePhotoManagement();
    initializeTaskActions();
    initializeModalHandlers();
    initializeKeyboardNavigation();
    initializeRealTimeUpdates();
    initPhotoModal(); // Initialize enhanced photo modal
    
    // Test modal functionality
    console.log('Photo modal elements check:');
    console.log('Modal element:', document.getElementById('photoModal'));
    console.log('Modal photo element:', document.getElementById('modalPhoto'));
    console.log('openPhotoModal function:', typeof window.openPhotoModal);
});

// Task Timer Functionality
function initializeTaskTimer() {
    const timerDisplay = document.getElementById('timerText');
    const startBtn = document.getElementById('startTimerBtn');
    const pauseBtn = document.getElementById('pauseTimerBtn');
    const resetBtn = document.getElementById('stopTimerBtn');
    const taskId = {{ task.id }};

    let timerInterval;
    let startTime;
    let elapsedTime = 0;
    let isRunning = false;

    // Load saved timer state
    loadTimerState();

    function updateTimerDisplay() {
        const totalSeconds = Math.floor(elapsedTime / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        timerDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function startTimer() {
        if (!isRunning) {
            startTime = Date.now() - elapsedTime;
            timerInterval = setInterval(() => {
                elapsedTime = Date.now() - startTime;
                updateTimerDisplay();
                saveTimerState();
            }, 1000);
            isRunning = true;
            updateTimerButtons();
        }
    }

    function pauseTimer() {
        if (isRunning) {
            clearInterval(timerInterval);
            isRunning = false;
            updateTimerButtons();
            saveTimerState();
        }
    }

    function resetTimer() {
        clearInterval(timerInterval);
        elapsedTime = 0;
        isRunning = false;
        updateTimerDisplay();
        updateTimerButtons();
        saveTimerState();
    }

    function updateTimerButtons() {
        startBtn.disabled = isRunning;
        pauseBtn.disabled = !isRunning;
        resetBtn.disabled = false;
    }

    function saveTimerState() {
        const state = {
            elapsedTime: elapsedTime,
            isRunning: isRunning,
            startTime: startTime
        };
        localStorage.setItem(`task_timer_${taskId}`, JSON.stringify(state));
    }

    function loadTimerState() {
        const saved = localStorage.getItem(`task_timer_${taskId}`);
        if (saved) {
            const state = JSON.parse(saved);
            elapsedTime = state.elapsedTime || 0;
            isRunning = state.isRunning || false;
            startTime = state.startTime || Date.now();

            if (isRunning) {
                startTimer();
            } else {
                updateTimerDisplay();
            }
        }
        updateTimerButtons();
    }

    // Event listeners
    startBtn.addEventListener('click', startTimer);
    pauseBtn.addEventListener('click', pauseTimer);
    resetBtn.addEventListener('click', resetTimer);

    // Auto-save timer on page unload
    window.addEventListener('beforeunload', saveTimerState);

    // Export timer functions globally for HTML onclick handlers
    window.startTimer = startTimer;
    window.pauseTimer = pauseTimer;
    window.stopTimer = resetTimer; // stopTimer maps to resetTimer
}

// Checklist Management
function initializeChecklistManagement() {
    const checklistItems = document.querySelectorAll('.checklist-item');

    checklistItems.forEach(item => {
        const checkbox = item.querySelector('.checklist-checkbox');
        const itemId = item.dataset.itemId;

        if (checkbox) {
            checkbox.addEventListener('change', function() {
                updateChecklistItem(itemId, this.checked);
            });
        }

        // Initialize photo and notes buttons
        const photoBtn = item.querySelector('.btn-photo');
        const notesBtn = item.querySelector('.btn-notes');

        if (photoBtn) {
            photoBtn.addEventListener('click', () => openPhotoModal(itemId));
        }

        if (notesBtn) {
            notesBtn.addEventListener('click', () => openNotesModal(itemId));
        }
    });
}

async function updateChecklistItem(itemOrId, completed) {
    let item, itemId;

    // Handle both calling patterns: updateChecklistItem(this) and updateChecklistItem(id, completed)
    if (typeof itemOrId === 'object' && itemOrId.nodeType === 1) {
        // Called from HTML onchange with 'this'
        item = itemOrId.closest('.checklist-item');
        itemId = item.dataset.itemId;
        completed = itemOrId.checked;
    } else {
        // Called from JavaScript with separate parameters
        itemId = itemOrId;
        item = document.querySelector(`[data-item-id="${itemId}"]`);
    }

    if (!item) return;

    try {
        item.classList.add('loading');

        const response = await fetch(`/api/staff/checklist/${itemId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                completed: completed,
                completed_at: completed ? new Date().toISOString() : null
            })
        });

        if (response.ok) {
            const data = await response.json();
            updateChecklistItemUI(item, data);
            updateProgressOverview();
            showNotification('Checklist item updated successfully', 'success');
        } else {
            throw new Error('Failed to update checklist item');
        }
    } catch (error) {
        console.error('Error updating checklist item:', error);
        showNotification('Failed to update checklist item', 'error');
        // Revert checkbox state
        const checkbox = item.querySelector('.checklist-checkbox');
        if (checkbox) {
            checkbox.checked = !completed;
        }
    } finally {
        item.classList.remove('loading');
    }
}

function updateChecklistItemUI(item, data) {
    const checkbox = item.querySelector('.checklist-checkbox');
    const statusIcon = item.querySelector('.checklist-status');

    if (data.completed) {
        item.classList.add('completed');
        if (statusIcon) {
            statusIcon.innerHTML = '‚úì';
            statusIcon.style.color = '#10b981';
        }
    } else {
        item.classList.remove('completed');
        if (statusIcon) {
            statusIcon.innerHTML = '‚óã';
            statusIcon.style.color = '#64748b';
        }
    }

    // Update completion info if present
    const completionInfo = item.querySelector('.completion-info');
    if (completionInfo && data.completed_at) {
        const date = new Date(data.completed_at).toLocaleString();
        completionInfo.querySelector('.completion-date').textContent = date;
    }
}

// Photo Management
function initializePhotoManagement() {
    const photoUploadInputs = document.querySelectorAll('[id^="photo-input-"]');
    const photoUploadButtons = document.querySelectorAll('.btn-upload');
    const photoItems = document.querySelectorAll('.photo-item img');

    photoUploadInputs.forEach(input => {
        input.addEventListener('change', handlePhotoUpload);
    });

    photoUploadButtons.forEach(button => {
        button.addEventListener('click', function() {
            const responseId = this.dataset.responseId;
            const input = document.getElementById(`photo-input-${responseId}`);
            if (input) {
                input.click();
            }
        });
    });

    photoItems.forEach(img => {
        img.addEventListener('click', function() {
            const photoUrl = this.dataset.photoUrl;
            const photoId = this.dataset.photoId;
            openPhotoModal(photoUrl, photoId);
        });
    });

    // Photo removal buttons (including dynamically created ones)
    const photoRemoveButtons = document.querySelectorAll('.btn-photo-remove');
    photoRemoveButtons.forEach(button => {
        button.addEventListener('click', function() {
            const photoId = this.dataset.photoId;
            const responseId = this.dataset.responseId;
            const itemId = this.dataset.itemId;
            const photoUrl = this.dataset.photoUrl;

            if (photoId && responseId) {
                removePhoto(photoId, responseId);
            } else if (itemId && photoUrl) {
                removePhoto(itemId, photoUrl);
            }
        });
    });
}

async function handlePhotoUpload(event) {
    const file = event.target.files[0];
    const itemId = event.target.dataset.itemId;

    if (!file) return;

    // Validate file type
    if (!file.type.startsWith('image/')) {
        showNotification('Please select a valid image file', 'error');
        return;
    }

    // Validate file size (5MB limit)
    if (file.size > 5 * 1024 * 1024) {
        showNotification('File size must be less than 5MB', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('photo', file);
    formData.append('item_id', itemId);

    try {
        const response = await fetch('/api/staff/checklist/photo/upload/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            },
            body: formData
        });

        if (response.ok) {
            const data = await response.json();
            addPhotoToItem(itemId, data.photo_url);
            showNotification('Photo uploaded successfully', 'success');
        } else {
            throw new Error('Failed to upload photo');
        }
    } catch (error) {
        console.error('Error uploading photo:', error);
        showNotification('Failed to upload photo', 'error');
    }
}

function addPhotoToItem(itemId, photoUrl) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (!item) return;

    const photoGrid = item.querySelector('.photo-grid');
    if (!photoGrid) return;

    const photoItem = document.createElement('div');
    photoItem.className = 'photo-item';
    photoItem.innerHTML = `
        <img src="${photoUrl}" alt="Checklist photo" data-photo-url="${photoUrl}">
        <button class="btn-photo-remove" data-item-id="${itemId}" data-photo-url="${photoUrl}">√ó</button>
    `;

    // Add event listeners to the dynamically created elements
    const img = photoItem.querySelector('img');
    const removeBtn = photoItem.querySelector('.btn-photo-remove');

    img.addEventListener('click', () => openPhotoViewer(photoUrl));
    removeBtn.addEventListener('click', () => removePhoto(itemId, photoUrl));

    photoGrid.appendChild(photoItem);
}

async function removePhoto(itemId, photoUrl) {
    try {
        const response = await fetch('/api/staff/checklist/photo/remove/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                item_id: itemId,
                photo_url: photoUrl
            })
        });

        if (response.ok) {
            const photoItem = event.target.closest('.photo-item');
            photoItem.remove();
            showNotification('Photo removed successfully', 'success');
        } else {
            throw new Error('Failed to remove photo');
        }
    } catch (error) {
        console.error('Error removing photo:', error);
        showNotification('Failed to remove photo', 'error');
    }
}

// Task Actions
function initializeTaskActions() {
    const taskId = {{ task.id }};

    // Attach event listeners to task action buttons
    const startTaskBtn = document.querySelector('.btn-action.start-task');
    const completeTaskBtn = document.querySelector('.btn-action.complete-task');
    const addNoteBtn = document.querySelector('.btn-action.add-note');
    const shareTaskBtn = document.querySelector('.btn-action.share-task');

    if (startTaskBtn && !startTaskBtn.disabled) {
        startTaskBtn.addEventListener('click', () => window.startTask(taskId));
    }

    if (completeTaskBtn && !completeTaskBtn.disabled) {
        completeTaskBtn.addEventListener('click', () => window.completeTask(taskId));
    }

    if (addNoteBtn) {
        addNoteBtn.addEventListener('click', window.addNote);
    }

    if (shareTaskBtn) {
        shareTaskBtn.addEventListener('click', window.shareTask);
    }

    const reportLostFoundBtn = document.querySelector('.btn-action.report-lost-found');
    if (reportLostFoundBtn) {
        reportLostFoundBtn.addEventListener('click', window.reportLostFound);
    }

    // Navigation buttons
    const prevTaskBtn = document.querySelector('.btn-nav.prev-task');
    const nextTaskBtn = document.querySelector('.btn-nav.next-task');
    const backToListBtn = document.querySelector('.btn-nav.back-to-list');

    if (prevTaskBtn) {
        prevTaskBtn.addEventListener('click', goToPreviousTask);
    }

    if (nextTaskBtn) {
        nextTaskBtn.addEventListener('click', goToNextTask);
    }

    if (backToListBtn) {
        backToListBtn.addEventListener('click', () => window.history.back());
    }

    // Additional task action buttons
    const completeTaskBtnLarge = document.querySelector('.complete-task-btn');
    const addNoteBtnLarge = document.querySelector('.btn-add-note');

    if (completeTaskBtnLarge && !completeTaskBtnLarge.disabled) {
        completeTaskBtnLarge.addEventListener('click', () => completeTask(taskId));
    }

    if (addNoteBtnLarge) {
        addNoteBtnLarge.addEventListener('click', addNote);
    }
}

async function updateTaskStatus(taskId, status) {
    console.log('üöÄ Starting task status update:', { taskId, status });
    
    try {
        const csrfToken = getCsrfToken();
        console.log('üîë CSRF Token:', csrfToken ? 'Found' : 'Missing');
        
        const response = await fetch(`/api/staff/tasks/${taskId}/status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ status: status })
        });

        console.log('üì° API Response status:', response.status);

        if (response.ok) {
            const data = await response.json();
            console.log('üìä API Response data:', data);
            
            updateTaskStatusUI(data);
            showNotification(`Task ${status.replace('_', ' ')} successfully`, 'success');

            // Stay on task detail page after completion
            // Task status will be updated in UI
        } else {
            const errorText = await response.text();
            console.error('‚ùå API Error Response:', errorText);
            throw new Error(`API Error ${response.status}: ${errorText}`);
        }
    } catch (error) {
        console.error('‚ùå Error updating task status:', error);
        showNotification(`Failed to update task status: ${error.message}`, 'error');
    }
}

function updateTaskStatusUI(data) {
    console.log('üîÑ Updating UI with data:', data);
    
    // Update status badge
    const statusBadge = document.querySelector('.status-badge');
    if (statusBadge) {
        statusBadge.textContent = data.status_display;
        statusBadge.className = `status-badge status-${data.status.replace('-', '')}`;
        console.log('‚úÖ Status badge updated');
    } else {
        console.log('‚ùå Status badge not found');
    }

    // Update action buttons - FIXED SELECTORS
    const startBtn = document.querySelector('.btn-action.start-task');
    const completeBtn = document.querySelector('.btn-action.complete-task');
    
    console.log('üîç Buttons found:', {
        startBtn: !!startBtn,
        completeBtn: !!completeBtn
    });

    if (data.status === 'in-progress') {
        if (startBtn) {
            startBtn.disabled = true;
            startBtn.textContent = '‚ñ∂Ô∏è Started';
            startBtn.style.opacity = '0.6';
            console.log('‚úÖ Start button disabled and marked as started');
        }
        if (completeBtn) {
            completeBtn.disabled = false;
            completeBtn.style.opacity = '1';
            console.log('‚úÖ Complete button enabled');
        }
    } else if (data.status === 'completed') {
        if (startBtn) {
            startBtn.disabled = true;
            startBtn.style.opacity = '0.6';
            console.log('‚úÖ Start button disabled');
        }
        if (completeBtn) {
            completeBtn.disabled = true;
            completeBtn.textContent = '‚úÖ Completed';
            completeBtn.style.opacity = '0.6';
            console.log('‚úÖ Complete button disabled and marked as completed');
        }
    }
    
    console.log('‚úÖ UI update complete');

    // Update progress overview
    updateProgressOverview();
}

// Modal Handlers
function initializeModalHandlers() {
    const modals = document.querySelectorAll('.photo-modal, .note-modal, .lost-found-modal');
    const closeButtons = document.querySelectorAll('.modal-close, .modal-close-btn');

    closeButtons.forEach(btn => {
        btn.addEventListener('click', closeModal);
    });

    // Close modal on backdrop click
    modals.forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });
    
    // Initialize notes modal form submission
    const notesForm = document.querySelector('#noteModal .item-form');
    if (notesForm) {
        notesForm.addEventListener('submit', handleNotesSave);
    }
}

function openPhotoModal(photoUrl, photoId) {
    console.log('openPhotoModal called with:', photoUrl, photoId);
    
    const modal = document.getElementById('photoModal');
    const modalPhoto = document.getElementById('modalPhoto');
    
    if (!modal) {
        console.error('Photo modal not found!');
        return;
    }
    
    if (!modalPhoto) {
        console.error('Modal photo element not found!');
        return;
    }
    
    // Reset zoom
    modalPhoto.style.transform = 'scale(1)';
    modalPhoto.style.cursor = 'zoom-in';
    
    // Set photo source
    modalPhoto.src = photoUrl;
    
    // Find the photo data from the gallery
    const photoElement = document.querySelector(`[data-photo-id="${photoId}"]`);
    if (photoElement) {
        // Extract photo metadata
        const photoType = photoElement.dataset.photoType;
        const photoTypeDisplay = photoElement.querySelector('.photo-type-badge')?.textContent || photoType;
        const photoStatus = photoElement.querySelector('.photo-status')?.textContent || 'Unknown';
        const photoStatusClass = photoElement.querySelector('.photo-status')?.className || '';
        const photoDescription = photoElement.querySelector('.photo-description')?.textContent || '';
        
        // Update modal content
        document.getElementById('modalPhotoTitle').textContent = `${photoTypeDisplay} Photo`;
        document.getElementById('modalPhotoType').textContent = photoTypeDisplay;
        document.getElementById('modalPhotoStatus').textContent = photoStatus;
        document.getElementById('modalPhotoStatus').className = `photo-status ${photoStatusClass}`;
        document.getElementById('modalPhotoDate').textContent = new Date().toLocaleString();
        document.getElementById('modalPhotoDescription').textContent = photoDescription;
        
        // Update approval controls
        updateModalApprovalControls(photoId, photoStatus);
    }
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function updateModalApprovalControls(photoId, currentStatus) {
    const controlsContainer = document.getElementById('modalApprovalControls');
    const canApprove = canApprovePhotos();
    
    if (!canApprove) {
        controlsContainer.innerHTML = '<p class="text-muted">You do not have permission to approve photos</p>';
        return;
    }
    
    let controlsHtml = '';
    
    if (currentStatus === 'pending') {
        controlsHtml = `
            <button class="btn-approve" onclick="approvePhoto(${photoId}); closePhotoModal();">
                ‚úì Approve Photo
            </button>
            <button class="btn-reject" onclick="rejectPhoto(${photoId}); closePhotoModal();">
                ‚úó Reject Photo
            </button>
        `;
    } else if (currentStatus === 'approved') {
        controlsHtml = `
            <span class="status-approved">‚úì Approved</span>
            <button class="btn-archive" onclick="archivePhoto(${photoId}); closePhotoModal();">
                üìÅ Archive Photo
            </button>
        `;
    } else if (currentStatus === 'rejected') {
        controlsHtml = `
            <span class="status-rejected">‚úó Rejected</span>
            <button class="btn-approve" onclick="approvePhoto(${photoId}); closePhotoModal();">
                ‚úì Approve Photo
            </button>
        `;
    } else if (currentStatus === 'archived') {
        controlsHtml = `
            <span class="status-archived">üìÅ Archived</span>
            <button class="btn-approve" onclick="approvePhoto(${photoId}); closePhotoModal();">
                ‚úì Unarchive Photo
            </button>
        `;
    }
    
    controlsContainer.innerHTML = controlsHtml;
}

function openPhotoViewer(src) {
    const modal = document.getElementById('photoModal');
    const modalPhoto = document.getElementById('modalPhoto');
    modalPhoto.src = src;

    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closePhotoModal() {
    const modal = document.getElementById('photoModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Zoom functionality
let currentZoom = 1;
const minZoom = 0.5;
const maxZoom = 3;
const zoomStep = 0.25;

function initPhotoModal() {
    const modal = document.getElementById('photoModal');
    const modalPhoto = document.getElementById('modalPhoto');
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    const resetZoomBtn = document.getElementById('resetZoomBtn');
    
    if (!modal || !modalPhoto) return;
    
    // Zoom in
    if (zoomInBtn) {
        zoomInBtn.addEventListener('click', () => {
            currentZoom = Math.min(currentZoom + zoomStep, maxZoom);
            modalPhoto.style.transform = `scale(${currentZoom})`;
            updateZoomButtons();
        });
    }
    
    // Zoom out
    if (zoomOutBtn) {
        zoomOutBtn.addEventListener('click', () => {
            currentZoom = Math.max(currentZoom - zoomStep, minZoom);
            modalPhoto.style.transform = `scale(${currentZoom})`;
            updateZoomButtons();
        });
    }
    
    // Reset zoom
    if (resetZoomBtn) {
        resetZoomBtn.addEventListener('click', () => {
            currentZoom = 1;
            modalPhoto.style.transform = 'scale(1)';
            updateZoomButtons();
        });
    }
    
    // Click to zoom
    modalPhoto.addEventListener('click', () => {
        if (currentZoom === 1) {
            currentZoom = 2;
            modalPhoto.style.cursor = 'zoom-out';
        } else {
            currentZoom = 1;
            modalPhoto.style.cursor = 'zoom-in';
        }
        modalPhoto.style.transform = `scale(${currentZoom})`;
        updateZoomButtons();
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (modal.style.display === 'none') return;
        
        switch(e.key) {
            case 'Escape':
                closePhotoModal();
                break;
            case '+':
            case '=':
                e.preventDefault();
                zoomInBtn?.click();
                break;
            case '-':
                e.preventDefault();
                zoomOutBtn?.click();
                break;
            case '0':
                e.preventDefault();
                resetZoomBtn?.click();
                break;
        }
    });
}

function updateZoomButtons() {
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    
    if (zoomInBtn) {
        zoomInBtn.disabled = currentZoom >= maxZoom;
        zoomInBtn.style.opacity = currentZoom >= maxZoom ? '0.5' : '1';
    }
    
    if (zoomOutBtn) {
        zoomOutBtn.disabled = currentZoom <= minZoom;
        zoomOutBtn.style.opacity = currentZoom <= minZoom ? '0.5' : '1';
    }
}

function openNotesModal(itemId) {
    const modal = document.getElementById('noteModal');
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    const notesInput = modal.querySelector('.notes-input');
    const itemNotes = item.querySelector('.item-notes');

    if (itemNotes) {
        notesInput.value = itemNotes.textContent.trim();
    }

    modal.dataset.itemId = itemId;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    console.log('üö™ Closing modal...');
    const modals = document.querySelectorAll('.photo-modal, .note-modal, .lost-found-modal');
    console.log('üö™ Found modals:', modals.length);
    modals.forEach(modal => {
        modal.style.display = 'none';
        console.log('üö™ Closed modal:', modal.id || modal.className);
    });
    document.body.style.overflow = 'auto';
    console.log('üö™ Modal closed successfully');
}

async function handleNotesSave(e) {
    e.preventDefault();
    console.log('üíæ Saving notes...');
    
    const form = e.target;
    const notesInput = form.querySelector('.notes-input');
    const notes = notesInput.value.trim();
    
    console.log('üíæ Notes content:', notes);
    
    if (!notes) {
        showNotification('Please enter some notes', 'error');
        return;
    }
    
    try {
        const taskId = {{ task.id }};
        const csrfToken = getCsrfToken();
        
        const response = await fetch(`/api/staff/tasks/${taskId}/status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ 
                status: '{{ task.status }}',  // Keep current status
                description: notes  // Update description with notes
            })
        });
        
        if (response.ok) {
            showNotification('Notes saved successfully!', 'success');
            closeModal();
            
            // Update the task description in the UI
            let taskDescriptionParagraph = document.querySelector('.task-description p');
            
            if (taskDescriptionParagraph) {
                // Update existing description - replace content completely
                console.log('üìù Updating existing description paragraph');
                console.log('üìù Old content:', taskDescriptionParagraph.textContent);
                console.log('üìù New content:', notes);
                
                // Clear the paragraph completely and set new content
                taskDescriptionParagraph.textContent = notes;
                
                console.log('üìù Updated content:', taskDescriptionParagraph.textContent);
                // Show the description section if it was hidden
                const taskDescriptionSection = document.querySelector('.task-description');
                if (taskDescriptionSection) {
                    taskDescriptionSection.style.display = 'block';
                }
            } else {
                // Create description section if it doesn't exist
                const taskDetails = document.querySelector('.task-details');
                if (taskDetails) {
                    const descriptionSection = document.createElement('div');
                    descriptionSection.className = 'task-description';
                    
                    const heading = document.createElement('h4');
                    heading.textContent = 'Description';
                    
                    const paragraph = document.createElement('p');
                    paragraph.textContent = notes;
                    
                    descriptionSection.appendChild(heading);
                    descriptionSection.appendChild(paragraph);
                    
                    // Insert after task-info section
                    const taskInfo = taskDetails.querySelector('.task-info');
                    if (taskInfo) {
                        taskInfo.insertAdjacentElement('afterend', descriptionSection);
                    } else {
                        taskDetails.appendChild(descriptionSection);
                    }
                }
            }
        } else {
            throw new Error('Failed to save notes');
        }
    } catch (error) {
        console.error('Error saving notes:', error);
        showNotification('Failed to save notes: ' + error.message, 'error');
    }
}

async function handleLostFoundSubmit(e) {
    e.preventDefault();
    console.log('üîç Submitting lost & found item...');
    
    const form = e.target;
    const formData = new FormData(form);
    
    // Validate required fields
    const title = formData.get('title').trim();
    const description = formData.get('description').trim();
    const foundLocation = formData.get('found_location').trim();
    
    if (!title || !description || !foundLocation) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    try {
        const taskId = {{ task.id }};
        const csrfToken = getCsrfToken();
        
        const lostFoundData = {
            title: title,
            description: description,
            category: formData.get('category') || '',
            estimated_value: formData.get('estimated_value') || null,
            found_location: foundLocation,
            storage_location: formData.get('storage_location') || '',
            notes: formData.get('notes') || '',
            property_ref: {{ task.property_ref.id }},
            task: taskId,
            {% if task.booking %}
            booking: {{ task.booking.id }},
            {% endif %}
            status: 'found'
        };
        
        const response = await fetch('/api/staff/lost-found/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(lostFoundData)
        });
        
        if (response.ok) {
            const result = await response.json();
            showNotification('Lost & found item reported successfully!', 'success');
            closeModal();
            
            // Reset form
            form.reset();
            
            // Optionally redirect to lost & found list
            setTimeout(() => {
                window.location.href = '/api/staff/lost-found/';
            }, 1500);
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to report item');
        }
    } catch (error) {
        console.error('Error reporting lost & found item:', error);
        showNotification('Failed to report item: ' + error.message, 'error');
    }
}

// Keyboard Navigation
function initializeKeyboardNavigation() {
    const checklistItems = document.querySelectorAll('.checklist-item');

    checklistItems.forEach((item, index) => {
        item.setAttribute('tabindex', '0');

        item.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const checkbox = this.querySelector('.checklist-checkbox');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            }
        });
    });
}

// Real-time Updates
function initializeRealTimeUpdates() {
    // Update progress every 30 seconds
    setInterval(updateProgressOverview, 30000);

    // Listen for task updates (if using WebSocket or Server-Sent Events)
    // This would be implemented based on your real-time infrastructure
}

// Progress Overview Updates
function updateProgressOverview() {
    const taskId = {{ task.id }};

    fetch(`/api/staff/tasks/${taskId}/progress/`)
        .then(response => response.json())
        .then(data => {
            // Accept flat fields or nested 'progress'
            const payload = typeof data.percentage !== 'undefined' ? data : (data.progress || {percentage:0, completed:0, total:0, remaining:0});
            updateProgressUI(payload);
        })
        .catch(error => {
            console.error('Error updating progress:', error);
        });
}

function updateProgressUI(data) {
    const progressFill = document.querySelector('.progress-fill');
    const progressPercentage = document.querySelector('.progress-percentage');
    const progressFraction = document.querySelector('.progress-fraction');

    if (progressFill) {
        const pct = Number.isFinite(data.percentage) ? data.percentage : 0;
        progressFill.style.width = `${pct}%`;
    }

    if (progressPercentage) {
        const pct = Number.isFinite(data.percentage) ? data.percentage : 0;
        progressPercentage.textContent = `${pct}%`;
    }

    if (progressFraction) {
        const completed = Number.isFinite(data.completed) ? data.completed : 0;
        const total = Number.isFinite(data.total) ? data.total : 0;
        progressFraction.textContent = `${completed}/${total} items`;
    }

    // Update detail items
    const completedItem = document.querySelector('.detail-value.completed');
    const remainingItem = document.querySelector('.detail-value.remaining');

    if (completedItem) {
        completedItem.textContent = Number.isFinite(data.completed) ? data.completed : 0;
    }

    if (remainingItem) {
        remainingItem.textContent = Number.isFinite(data.remaining) ? data.remaining : 0;
    }
}

// Utility Functions
function getCsrfToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-icon">${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span>
            <span class="notification-message">${message}</span>
        </div>
    `;

    // Add to page
    document.body.appendChild(notification);

    // Show notification
    setTimeout(() => notification.classList.add('show'), 100);

    // Remove notification after 3 seconds
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Add notification styles
const notificationStyles = `
<style>
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    background: white;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    max-width: 400px;
}

.notification.show {
    transform: translateX(0);
}

.notification-success {
    border-left: 4px solid #10b981;
}

.notification-error {
    border-left: 4px solid #ef4444;
}

.notification-info {
    border-left: 4px solid #3b82f6;
}

.notification-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.notification-icon {
    font-size: 1.25rem;
    font-weight: bold;
}

.notification-success .notification-icon {
    color: #10b981;
}

.notification-error .notification-icon {
    color: #ef4444;
}

.notification-info .notification-icon {
    color: #3b82f6;
}

.notification-message {
    color: #1e293b;
    font-size: 0.875rem;
}
</style>
`;

// Inject notification styles
document.head.insertAdjacentHTML('beforeend', notificationStyles);

// Export functions for global access
window.openPhotoViewer = openPhotoViewer;
window.removePhoto = removePhoto;

// Note: Global button functions are now defined at the top of the script before DOMContentLoaded

window.goToPreviousTask = function() {
    // Implement navigation to previous task
    const prevBtn = document.querySelector('.btn-nav[onclick*="previous"]');
    if (prevBtn && !prevBtn.disabled) {
        // This would need to be implemented based on your task list logic
        window.history.back();
    }
};

window.goToNextTask = function() {
    // Implement navigation to next task
    const nextBtn = document.querySelector('.btn-nav[onclick*="next"]');
    if (nextBtn && !nextBtn.disabled) {
        // This would need to be implemented based on your task list logic
        // For now, just show a message
        showNotification('Next task navigation not implemented yet', 'info');
    }
};

window.openPhotoManager = function(responseId) {
    // Open photo upload modal for specific checklist item
    const input = document.getElementById(`photo-input-${responseId}`);
    if (input) {
        input.click();
    }
};

window.toggleNotes = function(responseId) {
    // Toggle notes section for checklist item
    const notesSection = document.querySelector(`[data-item-id="${responseId}"] .notes-section`);
    if (notesSection) {
        notesSection.style.display = notesSection.style.display === 'none' ? 'block' : 'none';
    }
};

// Remove duplicate closeModal function - using the one defined above;

// Photo Approval Functions
async function approvePhoto(photoId) {
    await updatePhotoStatus(photoId, 'approved');
}

async function rejectPhoto(photoId) {
    await updatePhotoStatus(photoId, 'rejected');
}

async function archivePhoto(photoId) {
    await updatePhotoStatus(photoId, 'archived');
}

async function updatePhotoStatus(photoId, status) {
    try {
        const response = await fetch(`/api/tasks/{{ task.id }}/images/${photoId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ photo_status: status })
        });

        if (response.ok) {
            showNotification(`Photo ${status} successfully!`, 'success');
            // Reload the page to show updated status
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            const error = await response.json();
            showNotification(`Failed to ${status} photo: ${error.detail || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        console.error('Error updating photo status:', error);
        showNotification(`Error updating photo status: ${error.message}`, 'error');
    }
}

async function deletePhoto(photoId) {
    if (!confirm('Are you sure you want to delete this photo record? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/api/tasks/{{ task.id }}/images/${photoId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });

        if (response.ok) {
            showNotification('Photo record deleted successfully!', 'success');
            // Reload the page to show updated status
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            const error = await response.json();
            showNotification(`Failed to delete photo: ${error.detail || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        console.error('Error deleting photo:', error);
        showNotification(`Error deleting photo: ${error.message}`, 'error');
    }
}

// Test function for debugging
function testPhotoModal() {
    console.log('Testing photo modal...');
    const firstImage = document.querySelector('.gallery-photo-item img');
    if (firstImage) {
        const photoUrl = firstImage.src;
        const photoId = firstImage.dataset.photoId;
        console.log('Testing with:', photoUrl, photoId);
        openPhotoModal(photoUrl, photoId);
    } else {
        console.log('No images found to test with');
    }
}

// Export additional functions for global access
window.openPhotoModal = openPhotoModal;
window.updateChecklistItem = updateChecklistItem;
window.approvePhoto = approvePhoto;
window.rejectPhoto = rejectPhoto;
window.archivePhoto = archivePhoto;
window.deletePhoto = deletePhoto;
window.testPhotoModal = testPhotoModal;
</script>
{% endblock %}

{% block extra_css %}
<style>
/* Enhanced Task Detail Styles */
.task-detail-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    max-width: 1200px;
    margin: 0 auto;
}

/* Enhanced Task Header */
.task-header-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    margin: -1rem -1rem 1.5rem -1rem;
}

.task-header-content {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    padding: 2rem;
}

.task-info-section {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.task-title-section h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: 700;
    color: white;
}

.task-badges {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.status-badge, .type-badge, .priority-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pending { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
.status-in-progress { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
.status-completed { background: rgba(16, 185, 129, 0.2); color: #34d399; }
.status-cancelled { background: rgba(239, 68, 68, 0.2); color: #f87171; }

.type-badge { background: rgba(255, 255, 255, 0.2); color: white; }
.priority-badge.overdue { background: rgba(239, 68, 68, 0.8); color: white; }
.priority-badge.urgent { background: rgba(245, 158, 11, 0.8); color: white; }

.task-meta-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.75rem;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
}

.meta-icon {
    font-size: 1rem;
    min-width: 20px;
}

.task-description {
    background: rgba(255, 255, 255, 0.1);
    padding: 1rem;
    border-radius: 8px;
    backdrop-filter: blur(10px);
}

.task-description h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
    font-weight: 600;
}

.task-description p {
    margin: 0;
    line-height: 1.5;
}

/* Task Actions Section */
.task-actions-section {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.crud-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    padding: 1rem;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
}

.crud-actions .btn-action {
    background: #f1f5f9;
    color: #475569;
    border: 1px solid #e2e8f0;
    padding: 0.75rem 1rem;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.crud-actions .btn-action:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
    transform: translateY(-1px);
}

.crud-actions .btn-action.btn-danger {
    background: #fef2f2;
    color: #dc2626;
    border-color: #fecaca;
}

.crud-actions .btn-action.btn-danger:hover {
    background: #dc2626;
    color: white;
    border-color: #dc2626;
}

/* Photo Approval Styles */
.photo-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.photo-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
}

.photo-status.status-pending {
    background: #fef3c7;
    color: #92400e;
}

.photo-status.status-approved {
    background: #d1fae5;
    color: #065f46;
}

.photo-status.status-rejected {
    background: #fee2e2;
    color: #991b1b;
}

.photo-status.status-archived {
    background: #e5e7eb;
    color: #374151;
}

.photo-approval-controls {
    margin-top: 12px;
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}

.photo-approval-controls button {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-approve {
    background: #10b981;
    color: white;
}

.btn-approve:hover {
    background: #059669;
}

.btn-reject {
    background: #ef4444;
    color: white;
}

.btn-reject:hover {
    background: #dc2626;
}

.btn-archive {
    background: #6b7280;
    color: white;
}

.btn-archive:hover {
    background: #4b5563;
}

.status-approved, .status-rejected, .status-archived {
    font-size: 12px;
    font-weight: 500;
    padding: 4px 8px;
    border-radius: 4px;
}

.status-approved {
    background: #d1fae5;
    color: #065f46;
}

.status-rejected {
    background: #fee2e2;
    color: #991b1b;
}

.status-archived {
    background: #e5e7eb;
    color: #374151;
}

.photo-description {
    font-size: 12px;
    color: #6b7280;
    margin: 4px 0;
    font-style: italic;
}

/* Photo Error States */
.photo-error {
    border: 2px dashed #ef4444;
    background: #fef2f2;
}

.photo-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 120px;
    background: #f9fafb;
    border-radius: 8px;
    margin-bottom: 8px;
}

.placeholder-icon {
    font-size: 24px;
    margin-bottom: 8px;
}

.placeholder-text {
    font-size: 12px;
    color: #6b7280;
    font-weight: 500;
}

.status-error {
    background: #fee2e2;
    color: #991b1b;
}

.btn-danger {
    background: #ef4444;
    color: white;
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-danger:hover {
    background: #dc2626;
}

/* Enhanced Photo Modal Styles */
.photo-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.photo-modal .modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    cursor: pointer;
}

.photo-modal .modal-content {
    position: relative;
    background: white;
    border-radius: 12px;
    max-width: 90vw;
    max-height: 90vh;
    width: 1000px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
}

.photo-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
    background: #f9fafb;
    border-radius: 12px 12px 0 0;
}

.photo-modal .photo-info h3 {
    margin: 0 0 8px 0;
    color: #111827;
    font-size: 18px;
    font-weight: 600;
}

.photo-modal .photo-meta-info {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
}

.photo-modal .modal-controls {
    display: flex;
    gap: 8px;
    align-items: center;
}

.photo-modal .btn-zoom {
    background: #6b7280;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 40px;
}

.photo-modal .btn-zoom:hover:not(:disabled) {
    background: #4b5563;
}

.photo-modal .btn-zoom:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.photo-modal .modal-close {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 40px;
}

.photo-modal .modal-close:hover {
    background: #dc2626;
}

.photo-modal .modal-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.photo-modal .photo-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    background: #f8fafc;
    overflow: auto;
}

.photo-modal .modal-photo {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    cursor: zoom-in;
    transition: transform 0.2s ease;
}

.photo-modal .photo-description-container {
    padding: 16px 20px;
    background: white;
    border-top: 1px solid #e5e7eb;
}

.photo-modal .photo-description {
    margin: 0;
    color: #6b7280;
    font-style: italic;
    font-size: 14px;
}

.photo-modal .modal-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
    border-radius: 0 0 12px 12px;
}

.photo-modal .photo-approval-section {
    flex: 1;
}

.photo-modal .photo-approval-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
}

.photo-modal .modal-actions {
    display: flex;
    gap: 12px;
}

.photo-modal .btn-secondary {
    background: #6b7280;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.photo-modal .btn-secondary:hover {
    background: #4b5563;
}

/* Responsive design */
@media (max-width: 768px) {
    .photo-modal .modal-content {
        max-width: 95vw;
        max-height: 95vh;
        width: 100%;
    }
    
    .photo-modal .modal-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
    }
    
    .photo-modal .modal-controls {
        width: 100%;
        justify-content: space-between;
    }
    
    .photo-modal .photo-meta-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .photo-modal .modal-footer {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
    }
    
    .photo-modal .photo-approval-controls {
        justify-content: center;
    }
}

.quick-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
}

.photo-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-action {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    backdrop-filter: blur(10px);
    min-height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.btn-action:hover:not(:disabled) {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.btn-action:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-action.start-task { background: rgba(16, 185, 129, 0.8); }
.btn-action.complete-task { background: rgba(59, 130, 246, 0.8); }
.btn-action.report-lost-found { background: rgba(168, 85, 247, 0.8); }

/* Task Timer */
.task-timer {
    background: rgba(255, 255, 255, 0.1);
    padding: 1rem;
    border-radius: 8px;
    backdrop-filter: blur(10px);
}

.timer-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}

.timer-icon {
    font-size: 1.25rem;
}

.timer-text {
    font-size: 1.5rem;
    font-weight: 700;
    font-family: 'Courier New', monospace;
}

.timer-controls {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
}

.btn-timer {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-timer:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Navigation Actions */
.navigation-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.btn-nav {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    flex: 1;
    min-height: 40px;
}

.btn-nav:hover {
    background: rgba(255, 255, 255, 0.2);
}

.btn-nav.back-to-list {
    background: rgba(107, 114, 128, 0.8);
}

/* Progress Overview */
.progress-overview {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.progress-header h3 {
    margin: 0;
    color: #1e293b;
}

.progress-stats {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.25rem;
}

.progress-percentage {
    font-size: 1.5rem;
    font-weight: 700;
    color: #667eea;
}

.progress-fraction {
    font-size: 0.875rem;
    color: #64748b;
}

.progress-bar-container {
    position: relative;
    margin-bottom: 1rem;
}

.progress-bar {
    height: 12px;
    background: #e2e8f0;
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 6px;
    transition: width 0.3s ease;
}

.progress-milestones {
    position: absolute;
    top: -20px;
    left: 0;
    right: 0;
    height: 20px;
}

.milestone {
    position: absolute;
    font-size: 0.75rem;
    color: #64748b;
    transform: translateX(-50%);
    font-weight: 500;
}

.progress-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 6px;
}

.detail-label {
    font-weight: 500;
    color: #374151;
}

.detail-value {
    font-weight: 600;
    color: #1e293b;
}

.detail-value.completed { color: #10b981; }
.detail-value.remaining { color: #f59e0b; }

/* Checklist Container */
.checklist-container {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.checklist-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
}

.section-header {
    background: #f8fafc;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.section-title {
    margin: 0;
    color: #1e293b;
    font-size: 1.125rem;
    font-weight: 600;
}

.section-progress {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
    color: #64748b;
}

.section-count, .section-completed {
    font-weight: 500;
}

.checklist-grid {
    display: grid;
    gap: 1rem;
    padding: 1.5rem;
}

.checklist-item {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    transition: all 0.2s ease;
}

.checklist-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.checklist-item.completed {
    background: #f0fdf4;
    border-color: #10b981;
}

.checklist-header {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.completion-indicator {
    flex-shrink: 0;
    margin-top: 0.25rem;
}

.checklist-checkbox {
    width: 20px;
    height: 20px;
    accent-color: #667eea;
    cursor: pointer;
}

.checklist-status {
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
}

.item-content {
    flex: 1;
}

.item-title {
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.required-indicator {
    color: #ef4444;
    font-size: 0.875rem;
}

.item-description {
    color: #64748b;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
    line-height: 1.4;
}

.item-meta {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    font-size: 0.75rem;
}

.item-type {
    background: #e2e8f0;
    color: #374151;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-weight: 500;
    text-transform: uppercase;
}

.blocking-badge {
    background: #fef2f2;
    color: #dc2626;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-weight: 500;
}

.item-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

.btn-photo, .btn-notes {
    background: #f1f5f9;
    color: #475569;
    border: 1px solid #e2e8f0;
    padding: 0.5rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 36px;
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-photo:hover, .btn-notes:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

/* Item Form */
.item-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-label {
    font-weight: 500;
    color: #374151;
    font-size: 0.875rem;
}

.form-control {
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.875rem;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    font-family: inherit;
}

.form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-control.notes-input {
    resize: vertical;
    min-height: 80px;
}

.form-display {
    background: #f8fafc;
    padding: 0.75rem;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
}

.form-value {
    color: #1e293b;
    line-height: 1.5;
}

/* Unified Photo Gallery */
.unified-photo-gallery {
    background: rgba(255, 255, 255, 0.1);
    padding: 1rem;
    border-radius: 8px;
    backdrop-filter: blur(10px);
    margin-top: 1rem;
}

.unified-photo-gallery h4 {
    margin: 0 0 1rem 0;
    color: white;
    font-size: 1rem;
    font-weight: 600;
}

.photo-gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 0.75rem;
}

.gallery-photo-item {
    position: relative;
    aspect-ratio: 1;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid rgba(255, 255, 255, 0.2);
    cursor: pointer;
    transition: transform 0.2s ease, border-color 0.2s ease;
}

.gallery-photo-item:hover {
    transform: scale(1.05);
    border-color: rgba(255, 255, 255, 0.4);
}

.gallery-photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.photo-meta {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.photo-type-badge {
    background: rgba(102, 126, 234, 0.8);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
}

.checklist-badge {
    background: rgba(16, 185, 129, 0.8);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

/* Photo Section */
.photo-section {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 0.75rem;
}

.photo-item {
    position: relative;
    aspect-ratio: 1;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid #e2e8f0;
}

.photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.photo-item img:hover {
    transform: scale(1.05);
}

.btn-photo-remove {
    position: absolute;
    top: 4px;
    right: 4px;
    background: rgba(239, 68, 68, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    transition: background-color 0.2s ease;
}

.btn-photo-remove:hover {
    background: rgba(239, 68, 68, 1);
}

.photo-upload {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.btn-upload {
    background: #f1f5f9;
    color: #475569;
    border: 1px solid #e2e8f0;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.875rem;
}

.btn-upload:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

/* Notes Section */
.notes-section {
    border-top: 1px solid #e2e8f0;
    padding-top: 1rem;
    margin-top: 1rem;
}

/* Completion Info */
.completion-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: #f0fdf4;
    border: 1px solid #10b981;
    border-radius: 6px;
    font-size: 0.875rem;
    color: #065f46;
}

.completion-icon {
    font-size: 1rem;
}

/* Completion Actions */
.completion-actions {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
}

.completion-message {
    margin-bottom: 1.5rem;
    padding: 1rem;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 500;
}

.completion-message.success {
    background: #f0fdf4;
    color: #065f46;
    border: 1px solid #10b981;
}

.completion-message.info {
    background: #eff6ff;
    color: #1e40af;
    border: 1px solid #3b82f6;
}

.btn-lg {
    padding: 0.875rem 2rem;
    font-size: 1rem;
    font-weight: 600;
    min-height: 48px;
}

/* Empty States */
.empty-checklist {
    text-align: center;
    padding: 3rem 1rem;
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.empty-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.5rem;
}

.empty-message {
    color: #64748b;
    margin-bottom: 1.5rem;
}

.empty-actions {
    display: flex;
    justify-content: center;
    gap: 0.75rem;
}

/* Task Notes */
.task-notes {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
}

.notes-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.notes-header h3 {
    margin: 0;
    color: #1e293b;
}

.btn-add-note {
    background: #667eea;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: background-color 0.2s ease;
}

.btn-add-note:hover {
    background: #5a67d8;
}

.notes-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

/* Modal Styles */
.photo-modal, .note-modal, .lost-found-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
}

.modal-content {
    background: white;
    border-radius: 12px;
    max-width: 90vw;
    max-height: 90vh;
    width: 600px;
    position: relative;
    z-index: 1001;
    overflow: hidden;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e2e8f0;
}

.modal-header h3 {
    margin: 0;
    color: #1e293b;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #64748b;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}

.modal-close:hover {
    background: #f1f5f9;
    color: #1e293b;
}

.modal-body {
    padding: 1.5rem;
    max-height: calc(90vh - 120px);
    overflow-y: auto;
}

#modalPhoto {
    width: 100%;
    height: auto;
    border-radius: 8px;
    max-height: 60vh;
    object-fit: contain;
}

.photo-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
    justify-content: center;
}

.form-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    margin-top: 1rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

@media (max-width: 640px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .task-header-content {
        grid-template-columns: 1fr;
        gap: 1.5rem;
        padding: 1.5rem;
    }

    .task-title-section h1 {
        font-size: 1.5rem;
    }

    .task-meta-grid {
        gap: 0.5rem;
    }

    .quick-actions {
        grid-template-columns: 1fr;
    }

    .navigation-actions {
        flex-direction: column;
    }

    .progress-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .progress-details {
        grid-template-columns: 1fr;
    }

    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 1rem;
    }

    .checklist-header {
        flex-direction: column;
        gap: 0.75rem;
    }

    .item-actions {
        justify-content: center;
    }

    .photo-grid {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    }

    .modal-content {
        width: 95vw;
        margin: 1rem;
    }

    .completion-actions {
        padding: 1rem;
    }
}

@media (max-width: 480px) {
    .task-header-card {
        margin: -1rem -1rem 1rem -1rem;
    }

    .task-header-content {
        padding: 1rem;
    }

    .checklist-grid {
        padding: 1rem;
        gap: 0.75rem;
    }

    .checklist-item {
        padding: 0.75rem;
    }

    .item-title {
        font-size: 0.875rem;
    }

    .progress-stats {
        align-items: flex-start;
    }
}

/* Accessibility Improvements */
.checklist-checkbox:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
}

.btn:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    .checklist-item, .task-notes, .completion-actions {
        border-width: 2px;
    }

    .btn {
        border-width: 2px;
    }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
    .checklist-item, .btn, .progress-fill {
        transition: none;
    }

    .checklist-item:hover {
        transform: none;
    }
}

/* Loading States */
.checklist-item.loading {
    opacity: 0.6;
    pointer-events: none;
}

.checklist-item.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid #e2e8f0;
    border-top: 2px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}
